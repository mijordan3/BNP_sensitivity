%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{proof}\prooflabel{pert_well_defined}
%
First, consider the case $p < \infty$. By Jensen's inequality applied pointwise
to the convex function $x \mapsto x^p$,
%
\begin{align*}
%
\abs{\pbase(\theta)^{1/p} + \phi(\theta) }^{p} \le{}&
    \left(\pbase(\theta)^{1/p} + \abs{\phi(\theta)} \right)^{p}
\\={}&
    2^p \left(\frac{1}{2}\pbase(\theta)^{1/p} +
              \frac{1}{2} \abs{\phi(\theta)} \right)^{p}
\\\le{}&
    2^{p-1} \left(\pbase(\theta) + \abs{\phi(\theta)}^p \right).
%
\end{align*}
%
Consequently,
%
\begin{align*}
%
\int \abs{\pbase(\theta)^{1/p} + \phi(\theta) }^{p} d\theta \le{}&
    2^{p-1} \int \left(\pbase(\theta) + \abs{\phi(\theta)}^p \right) d\theta
\\={}&
    2^{p-1} \left(1 + \norm{\phi}_p^p\right).
%
\end{align*}
%
So, as in \citep[Result 2]{gustafson:1996:local}, $\norm{\phi}_p < \infty$
implies that the prior can be normalized.

Next, by convexity,\footnote{Apply the definition of convexity to the points
$0$, $x$, and $x + y$, and again to the points $0$, $y$, and $x+y$, then add the
results.} for any $x \ge y \ge 0$,
%
\begin{align*}
%
(x + y)^p \ge{} x^p + y^p \mathand
(x - y)^p \le{} x^p - y^p.
%
\end{align*}
%
Also note that, since $\pbase(\theta) \ge 0$,
%
\begin{align*}
%
\pbase(\theta)^{1/p} + \phi(\theta) \le 0
\quad\Rightarrow\quad
\phi(\theta) \le 0 \mathand
\abs{\phi(\theta)} - \pbase(\theta)^{1/p} \ge 0.
%
\end{align*}
%
We can thus write
%
\begin{align*}
%
\MoveEqLeft
\int \mathrm{sign}(\pbase(\theta)^{1/p} + \phi(\theta))
    \abs{\pbase(\theta)^{1/p} + \abs{\phi(\theta)}}^{p} d\theta
={}\\&
    \int \left(\pbase(\theta)^{1/p} + \phi(\theta)\right)^{p}
        \ind{\pbase(\theta)^{1/p} + \phi(\theta) \ge 0}
        d\theta - \\&
    \int \left(\abs{\phi(\theta)} - \pbase(\theta)^{1/p}\right)^{p}
        \ind{\pbase(\theta)^{1/p} + \phi(\theta) < 0}
        d\theta
\\\ge{}&
    \int \left(\pbase(\theta) - \abs{\phi(\theta)}^{p}\right)
        \ind{\pbase(\theta)^{1/p} + \phi(\theta) \ge 0}
        d\theta - \\&
    \int \left(\abs{\phi(\theta)}^p - \pbase(\theta)\right)
        \ind{\pbase(\theta)^{1/p} + \phi(\theta) < 0}
        d\theta
\\={}&
    \int \pbase(\theta) d\theta - \int \abs{\phi(\theta)}^p d\theta
\\={}&
    1 - \norm{\phi}_p^p.
%
\end{align*}

Finally, consider $p = \infty$.  Since $\int \pbase(\theta) \lambda(d\theta) =
1$,
%
\begin{align*}
%
\exp(-\norminf{\phi}) \le{}
\abs{\int_0^1 \exp\left(\log \pbase(\theta) + \phi(\theta)\right) \lambda(d\theta)}
\le{}
\exp(\norminf{\phi}).
%
\end{align*}
%
so that $0 < \int \tilde{\p}(\theta \vert \phi) \lambda(d\theta) < \infty$
whenever $\norminf{\phi} < \infty$.
%
\end{proof}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Proof of eta_phi_deriv

\begin{proof}\prooflabel{eta_phi_deriv}
%
The map $\eta, \phi \mapsto \KL{\eta, \phi}$ is a map from the Banach space
$\mathbb{R}^\etadim \times \linf$ into the Banach space $\mathbb{R}$. Let us
take the L2 norm $\norm{\cdot}_2$ on $\mathbb{R}^{\etadim}$ and $\mathbb{R}$.
Let $\ball$ denote the ball $\ball_\eta \times \{ \phi: \norminf{\phi} <
\delta\}$ for some $\delta > 0$.  Let $\linop$ denote a linear operator from
$\ball$ to $\mathbb{R}^\etadim$, and define the dual norm
%
\begin{align*}
%
\norm{\linop}^* :=
    \sup_{\eta: \norm{\eta}_2 \le 1} \sup_{\phi: \norminf{\phi} \le 1}
     \norm{\linop(\eta, \phi)}_2.
%
\end{align*}

For any $\phi \in \ball_\phi$, observe that $\t \mapsto \pstick(\zeta \vert \t
\phi)$ satisfies \assuref{q_stick_regular} under \assuref{q_fun_stick_regular},
since, for any $f(\nu)$, $\lambda$-almost surely,
%
\begin{align*}
%
f(\nu) \phi(\nu) \le f(\nu) \norminf{\phi} \le \norminf{\phi} M(\nu).
%
\end{align*}
%
So, by \lemref{logq_continuous}, $\eta \mapsto \partial \KL{\eta, \phi} /
\partial \eta$ is continuous for any $\phi \in \ball_\phi$, and by a first-order
condition $\etaopt(\phi)$ satisfies
%
\begin{align*}
%
\fracat{\partial \KL{\eta, \phi}}
                {\partial \eta}
                {\etaopt(\phi)} = 0.
%
\end{align*}
%
Using this estimating equation, the key to the proof will be the implicit
function theorem for Banach spaces. To use the implicit function theorem, we
need to show that $\KLgrad{\eta, \phi}$ is continuously Fr{\'e}chet
differentiable at $\etaopt, \phiz$.

%  and that $\KLhess{\eta, \phi}$ is positive
% definite in $\ball$.  --- is the actually needed?

For the duration of the proof, define
%
\begin{align*}
%
\rho(\etanuk, \phi) :={}&
    \expect{\q(\nu \vert \etanuk)}{\phi(\etanuk)}
\mathand\\
\rho_\eta(\etanuk, \phi) :={}&
    \fracat{\partial \rho(\etanuk, \phi)}{\phi(\etanuk)}.
%
\end{align*}
%
Expanding $\logp(\zeta \vert \phi)$ in \eqref{vb_optimization} using
\eqref{phi_perturbation}, we see that
%
\begin{align}
\fracat{\partial \KL{\eta, \phi}}{\partial \eta}{\eta, \phi}
 ={}&
    \fracat{\partial \KL{\eta, \phiz}}{\partial \eta}{\eta} +
    \sumkm \rho_\eta(\etanuk, \phi). \eqlabel{kl_fun_pert}
%
\end{align}
%
By \assuref{kl_opt_ok}, $\partial \KL{\eta, \phiz} / \partial \eta$ is
continuously Fr{\'e}chet differentiable (it does not depend on $\phi$), so we
need consider only $\etanuk, \phi \mapsto \rho_\eta(\etanuk, \phi)$.  As
in the proof of \thmref{etat_deriv}, we will show continuous differentiability
by showing that the partial derivatives in the $\eta$ and $\phi$ directions
are continuous, this time in the dual norm $\norm{\cdot}^*$.

Let us first consider the partial derivative of $\rho_\eta(\etanuk, \phi)$ in
the $\eta$ direction. By \lemref{logq_derivs} \eqref{q_score_sens_is_cov},
%
\begin{align*}
%
\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} ={}&
\expect{\q(\nuk \vert \etanuk)}{
   \lqhessbar{\nuk \vert \etanuk}
       \left(
        \phi(\nuk) - \expect{\q(\nuk \vert \etanuk)}{\phi(\nuk)}
       \right)
       }.
%
\end{align*}
%
We need to show that the preceding expression is continuous in the dual norm
$\norm{\cdot}^*$.  The linear operator acts only in the $\eta$ direction, so
the dual norm is equivalent to operator norm $\normop{\cdot}$.  Since
the preceding display is linear in $\phi$,

%
\begin{align*}
%
\MoveEqLeft
%
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
      }^* \\ \le
%
& \norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
        \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi'}
    }^* + \\&\quad
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi'} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
    }^* \\ \le
%
& \normop{
    \expect{\q(\nuk \vert \etanuk)}
           {\lqhessbar{\nuk \vert \etanuk}}
    } \norminf{\phi - \phi'} + \\&\quad
\normop{
    \expect{\q(\nuk \vert \etanuk)}{\lqhessbar{\nuk \vert \etanuk}} -
    \expect{\q(\nuk \vert \etanuk')}{\lqhessbar{\nuk \vert \etanuk'}}
  } \norminf{\phi'}.
%
\end{align*}
%
Since continuity in $\norm{\cdot}_2$ implies continuity in $\normop{\cdot}$,
the preceding display and \lemref{logq_continuous} gives that
$\partial \rho_\eta(\etanuk, \phi) / \partial \etanuk$ is continuous,
since
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta} \lim_{\phi' \rightarrow \phi}
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
      }^* = 0.
%
\end{align*}

Next, we consider the partial derivative in the direction $\phi$.  Observing
that $\rho_\eta(\etanuk, \phi)$ is in fact linear in $\phi$, we see that the
partial derivative in the $\phi$ direction is given by the linear map
%
\begin{align}\eqlabel{rho_phi_partial}
%
\fracat{\partial \rho_\eta(\etanuk, \phi)}
       {\partial \phi}{\eta, \phi} \phi =
    \rho_\eta(\etanuk, \phi).
%
\end{align}
%
By \lemref{logq_derivs} \eqref{q_sens_is_cov},
%
\begin{align}\eqlabel{rho_phi_partial_cov}
%
\rho_\eta(\etanuk, \phi) ={}&
\expect{\q(\nuk \vert \etanuk)}
       {\lqgradbar{\nuk \vert \etanuk} \left(
        \phi(\nuk) - \expect{\q(\nuk \vert \etanuk)}{\phi(\nuk)}
       \right)
       }.
%
\end{align}
%
Note that
%
\begin{align*}
%
\sup_{\phi: \norminf{\phi} \le 1} \norm{\rho_\eta(\etanuk, \phi)}_2 \le{}&
    2 \expect{\q(\nuk \vert \etanuk)}
             {\norm{\lqgradbar{\nuk \vert \etanuk}}_2
             },
%
\end{align*}
%
so that $\phi \mapsto \rho_\eta(\etanuk, \phi)$ is a bounded linear operator and
so a valid derivative.

We now need to show continuity of the map of $\eta, \phi \mapsto
\rho_\eta(\etanuk, \phi)$ in the dual norm $\norm{\cdot}^*$.  Obviously the
linear map does not depend on the location $\phi$ at which it is evaluated, so
we need consider only continuity in $\eta$.  The linear map is zero in the
$\eta$ direction, so the dual norm is given by
%
\begin{align*}
%
\MoveEqLeft
\norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}^* ={}\\&
\sup_{\phi: \norminf{\phi} \le 1}
    \norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}_2 \le{}\\&
4 \norm{
    \expect{\q(\nuk \vert \etanuk')}{\lqgradbar{\nuk \vert \etanuk'}} -
    \expect{\q(\nuk \vert \etanuk')}{\lqgradbar{\nuk \vert \etanuk}}
}_2.
%
\end{align*}
%
Applying \lemref{logq_continuous} to the preceding display gives
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta}
    \norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}^* = 0,
%
\end{align*}
%
and so $\partial \rho_\eta(\eta, \phi) / \partial \phi$ is a bounded linear
function, continuous in the point at which it is evaluated, and so $\phi \mapsto
\rho_\eta(\eta, \phi)$ is continuously Fr{\'e}chet differentiable.

Since its partial derivatives are continuous, it follows by \citet[Proposition
4.14(c)]{zeidler:2013:functional} that the joint map $\eta, \phi \mapsto
\partial \KL{\eta, \phi} / \partial \eta$ is continously Fr{\'e}chet
differentiable.  Furthermore, \citet[Chapter 4 Condition
21b]{zeidler:2013:functional} holds since $\KLhess{\etaopt(\phiz), \phiz}$ is
invertible by \assuitemref{kl_opt_ok}{kl_hess}.   So we satisfy conditions (i),
(ii), and (iii) of \citet[Theorem 4.B(c)]{zeidler:2013:functional}, giving that
the function $\etaopt(\phi)$ exists.  Moreover, since we have shown that $\eta,
\phi \mapsto \partial \KL{\eta, \phi} / \partial \eta$ is continuously
Fre{\'e}chet differentiable ($C^1$ in the notation of Zeidler) in a neighborhood
of $\etaopt(\phiz), \phiz$, by \citet[Theorem 4.B(d)]{zeidler:2013:functional},
$\etaopt(\phi)$ is also continuously Fr{\'e}chet differentiable.

The form of the derivative is given by the directional derivatives $d \etaopt(\t
\phi) / d\t | \t = 0$, which, by \thmref{etat_deriv} and \eqref{rho_phi_partial,
rho_phi_partial_cov}, is given by
%
\begin{align*}
%
-\left(\fracat{\partial^2 \KL{\eta, \phiz}}
                {\partial \eta \partial \eta^T}
                {\etaopt}\right)^{-1}
\left(
    \sumkm \expect{\q(\nu \vert \etaoptnuk)}
                  {\lqgradbar{\nuk \vert \etanuk}
                   \phi(\nuk) }
\right).
%
\end{align*}
%
(Note that a general version of the same result is given immediately following
the statement of \citet[Theorem 4.B(c)]{zeidler:2013:functional}.)  In the last
line of the preceding display we have dropped the $\expect{\q(\nuk \vert
\etanuk)}{\phi(\nuk)}$ term since $\expect{\q(\nu \vert \etaoptnuk)}
{\lqgradbar{\nuk \vert \etanuk}} = 0$.  \Eqref{infl_fun_def} follows by
re-writing the preceding display as an integral.
%
\end{proof}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
