

A standard consequence of the dominated convergence theorem is the ability to
exchange integration and differentiation.  Since we will use this result
frequently, we state it here in our own notation as \thmref{dct}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{thm}\thmlabel{dct}
\citep[Theorem 16.8]{billingsley:1986:probability}
%
Let $\mu$ be sigma-finite measure on $\thetadom$, and let $S_\t \subseteq
\mathbb{R}$.  Let $f:\thetadom \times S_\t \mapsto \mathbb{R}$.

If there exists a function $M(\theta)$ with $\int M(\theta) \mu(d\theta) <
\infty$ such that $\abs{f(\theta, \t)} \le M(\theta)$, $\mu$-almost surely,
for all $\t \in S_\t$, then the map $\t \mapsto \int f(\theta, \t)
\mu(d\theta)$ is continuous.

Further, suppose that the derivative $\fracat{\partial f(\theta, \t)}{\partial
\t}{\t}$ exist $\mu$-almost surely for $\t \in S_\t$.  If there exists
an $M'(\theta)$ such that $\int M'(\theta) \mu(d\theta) < \infty$ and
$\abs{\fracat{\partial f(\theta, \t)}{\partial \t}{\t}} \le M'(\theta)$,
$\mu$-almost surely and for all $\t \in S_\t$, then
%
\begin{align*}
%
\fracat{\partial \int f(\theta, \t) \mu(d\theta)}{\partial \t}{\t} =
     \int \fracat{\partial f(\theta, \t)}{\partial \t}{\t} \mu(d\theta).
%
\end{align*}
%
\end{thm}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\begin{lem}\lemlabel{exchange_order}
%
Under \assuref{exchange_order_f}, at any $\eta, \t \in \ball_\eta \times
\ball_\t$, we can exchange the order of integration and differentiation in $\int
f(\theta, \eta, \t) \mu(d\theta)$ for the derivatives $\partial / \partial
\eta$, $\partial^2 / \partial \eta^2$, and $\partial^2 / \partial \eta \partial
\t$.
%
\begin{proof}

Let $\eta_d$ denote the $d-$th entry of the vector $\eta$.  Then
%
\begin{align*}
%
\abs{\partial f(\theta, \eta, \t) / \partial \eta_d} \le{}&
  \norm{\partial f(\theta, \eta, \t) / \partial \eta}_2
\textrm{,}\\
\abs{\partial^2 f(\theta, \eta, \t) / \partial \eta_d \partial \t} \le{}&
    \norm{\partial f(\theta, \eta, \t) / \partial \eta \partial \t}_2
\textrm{, and}\\
\abs{\partial^2 f(\theta, \eta, \t) /
       \partial \eta_{d_1} \partial \eta_{d_2}} \le{}&
     \norm{\partial f(\theta, \eta, \t) / \partial \eta \partial\eta^T}_2.
%
\end{align*}
%
The conclusion follows by repeatedly applying \thmref{dct} to the components
of the derivatives.

\end{proof}
\end{lem}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{logq_continuous}

Under \assuref{exchange_order}, the map $\eta, \t \mapsto \expect{\q(\theta
\vert \eta)}{\ptil(\theta \vert \t)}$ has continuous partial derivatives
$\partial / \partial \eta$, $\partial^2 / \partial \eta^2$, and $\partial^2 /
\partial \eta \partial \t$ at all $\eta, \t \in \ball_\eta \times \ball_\t$.
Furthermore,

\begin{align}
\fracat{\partial \expect{\q(\theta \vert \eta)}
              {\ptil(\theta \vert \t)}}{\partial \eta}{\eta}
={}&
\expect{\q(\theta \vert \eta)}
       {\lqgradbar{\theta \vert \eta}
       \ptil(\theta \vert \t)}
       \eqlabel{q_sens_is_cov}\\
%
\fracat{\partial^2 \expect{\q(\theta \vert \eta)}
      {\ptil(\theta \vert \t)}}{\partial \eta \partial \t}{\eta, \t}
={}&
\expect{\q(\theta \vert \eta)}
       {\lqgradbar{\theta \vert \eta}
       \fracat{\partial \ptil(\theta \vert \t)}{\partial \t}{\t}}
\eqlabel{q_sens_psi_grad_is_cov}.
%
\end{align}
%
\begin{proof}
%
We can write
%
\begin{align*}
%
R(a, b) :={} \frac{a}{b} \quad \Rightarrow
\expect{\q(\theta \vert \eta)}{\psi(\theta, \t)} ={}
R\left(\int \qtil(\theta \vert \eta) \psi(\theta, \t) \mu(d\theta),
  \int \qtil(\theta \vert \eta) \mu(d\theta)\right).
%
\end{align*}
%
If necessary, we can shrink $\ball_\eta$ so that the denominator $\int
\qtil(\theta \vert \eta) \mu(d\theta)$ is bounded below by a positive constant
for all $\eta \in \ball_\eta$.  With the denominator strongly positive, $R(a,b)$
is is a continuously differentiable function to all orders for all $\t, \eta \in
\ball_\t \times \ball_\eta$.  The desired results follow from
\assuref{exchange_order} by the chain rule.

\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\vspace{1em}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\prooflabel{etat_deriv}
\proofof{\thmref{etat_deriv}}
%
By \assuitemref{kl_opt_ok}{kl_diffable} and \lemref{logq_continuous}, $\eta
\mapsto \KL{\eta, \t}$ is continuously differentiable for all $\eta, \t \in
\ball_\eta \times \ball_\t$.  So, for all $\t \in \ball_\t$, the optimal
$\etaopt(\t)$ satisfies the first order condition:
%
\begin{align}\eqlabel{vb_first_order_condition}
%
\fracat{\partial \KL{\eta, \t}}{ \partial \eta}{\etaopt(\t), \t} ={}
\fracat{\partial \KL{\eta}}{ \partial \eta}{\etaopt(\t)} +
\fracat{\partial
    \expect{\q(\theta \vert \eta)}{\log \ptil(\theta \vert \t)}}
    {\partial \eta}
    {\etaopt(\t)}
={} 0
%
\end{align}

We wish to apply the implicit function theorem, \citet[Theorem
3.3.1]{krantz:2012:implicit}, to the estimating equation defined by
\eqref{vb_first_order_condition}. Again, by \assuitemref{kl_opt_ok}{kl_diffable}
and \lemref{logq_continuous}, the estimating equation given is continuously
differentiable in both $\eta$ and $\t$. The Jacobian of the estimating equation
is nonsingular by \assuitemref{kl_opt_ok}{kl_hess}, and valid in an open ball by
\assuitemref{kl_opt_ok}{kl_opt_interior}. For convenience,
\tabref{kranz_notation} shows the correspondence between our notation and that
of \citet[Theorem 3.3.1]{krantz:2012:implicit}.

\begin{center}
\begin{tabular}{|c|c|}
%
\hline Krantz \& Parks notation & Our notation \\\hline
$\Phi(x)$                       & $\KL{\eta, \t}$ \\\hline
$Q$                             & $1$ \\\hline
$M$                             & $\etadim$ \\\hline
$U$                             & $\ball_\eta \times \ball_\t$ \\\hline
$W$                             & $\ball_\t$ \\\hline
$x_1,\ldots,x_Q$                & $\t$ \\\hline
$x_{Q+1},\ldots,x_N$            & $\eta$ \\\hline
$f_1(x_a), \ldots,f_M(x_a)$     & $\etaopt(\t)$ \\\hline
%Equation 3.32                   & \assuitemref{kl_opt_ok}{kl_hess} \\\hline
%
\end{tabular}\tablabel{kranz_notation}
\end{center}

Finally, the form of the derivative is given by \citet[Theorem
3.3.1]{krantz:2012:implicit}, together with \eqref{q_sens_psi_grad_is_cov} of
\lemref{logq_continuous}.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\vspace{1em}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\prooflabel{pert_invariance}\proofof{\lemref{pert_invariance}}
%
Let $\mu$ and $\mu'$ denote two mutually absolutely continuous candidate
dominating measures for $\pbase$, with respective densities (Radon-Nikodym
derivatives) $\pbase(\theta)$ and $\pbase'(\theta)$.  Let the respective
densities of the measure $\p$ be denoted $\palt(\theta)$ and $\palt'(\theta)$ as
well.  Let $R(\theta) = \fracat{d\mu}{d\mu'}{\theta}$ denote the Radon-Nikodym
derivative of $\mu$ with respect to $\mu'$, and note that $\pbase'(\theta) =
R(\theta) \pbase(\theta)$ and $\palt'(\theta) = R(\theta) \palt(\theta)$.

We have that the perturbations for $\mu$ and $\mu'$ are given respectively by
%
\begin{align*}
%
\phi(\theta \vert \beta, \palt) ={}&
  \log \palt(\theta) - \log \pbase(\theta) + \log \beta \\
\phi'(\theta \vert \beta, \palt') ={}&
    \log \palt'(\theta) - \log \pbase'(\theta) + \log \beta
\\={}&
\log \palt(\theta) - \log R(\theta)
    - \log \pbase(\theta) + \log R(\theta)+ \log \beta
\\={}&
\phi(\theta \vert \beta, \palt).
%
\end{align*}
%
It follows that $\norminf{\phi(\cdot \vert \beta, \palt)} = \norminf{\phi'(\cdot
\vert \beta, \palt')}$.

Next, let $\tau := \tau(\theta)$ be an invertible transformation with Jacobian
$J(\theta) := \mathrm{det}\left(\fracat{d\tau}{d\theta^T}{\theta}\right)$. For
the dominating measure $\mu$, let $\pbase(\theta)$ and $\palt(\theta)$ denote
the densities of $\theta$ and $\pbase'(\tau)$ and $\palt'(\tau)$ denote the
densities of $\tau$.  The desired result follows by the exact same formal
argument as for the change of measure, except with $J(\theta) \mu(d\theta)$
and $\mu(d\tau)$ taking the place of $R(\theta) \mu(d\theta)$ and
$\mu'(d\theta)$, respectively.

We now prove that $\phi$ gives rise to valid priors when $\norminf{\phi} <
\infty$. Since the exponential funciton is positive, for any $\phi(\theta)$,
%
\begin{align*}
%
\ptil(\theta \vert \phi) = \pbase(\theta) \exp(\phi(\theta)) > 0,
%
\end{align*}
%
$\mu$-almost everywhere.  Furthermore, since $\int \pbase(\theta)
\lambda(d\theta) = 1$,
%
\begin{align*}
%
\exp(-\norminf{\phi}) \le{}
\int \pbase(\theta) \exp\left(\phi(\theta)\right) \mu(d\theta)
\le{}
\exp(\norminf{\phi}).
%
\end{align*}
%
so that $0 < \int \ptil(\theta \vert \phi) \mu(d\theta) < \infty$
whenever $\norminf{\phi} < \infty$.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\vspace{1em}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lem}\lemlabel{exchange_order_q_suffices}
%
Under \defref{prior_nl_pert},
\assuref{exchange_order_q} implies \assuref{exchange_order} when
$\norminf{\phi} < \infty$.

\begin{proof}
%
Since $\qtil(\theta \vert \eta) \phi(\theta) \le \qtil(\theta \vert \eta)
\delta$, and $\qtil(\theta \vert \eta)$ satisfies \assuref{exchange_order_f}
with some $M(\theta)$ by \assuref{exchange_order_q}, we can satisfy
\assuref{exchange_order_f} for $\qtil(\theta \vert \eta) \phi(\theta)$ with
$\max\{1, \delta\} M(\theta)$.  Finally, \lemref{exchange_order} implies that
\assuref{exchange_order} is satisfied.
%
\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{objective_is_frechet}

Under \assuref{exchange_order_q}, the map $\eta, \phi \mapsto \partial
\expect{\q(\theta \vert \eta)}{\phi(\theta)} / \partial \eta$ is Fr{\'e}chet
differentiable as a map from $\mathbb{R}^\etadim \times \linf  \mapsto
\mathbb{R}^\etadim$.
%
\begin{proof}
%
The map $\eta, \phi \mapsto  \partial \expect{\q(\theta \vert
\eta)}{\phi(\theta)} / \partial \eta$ is a map from the Banach space
$\mathbb{R}^\etadim \times \linf$ into the Banach space $\mathbb{R}$. Let us
take the L2 norm $\norm{\cdot}_2$ on $\mathbb{R}^{\etadim}$ and $\mathbb{R}$.
Let $\ball$ denote the ball $\ball_\eta \times \{ \phi: \norminf{\phi} <
\delta\}$ for some $\delta > 0$.  Let $\linop$ denote a linear operator from
$\ball$ to $\mathbb{R}^\etadim$, and define the dual norm
%
\begin{align*}
%
\norm{\linop}^* :=
    \sup_{\Delta \eta: \norm{\eta}_2 \le 1}
    \sup_{\Delta \phi: \norminf{\phi} \le 1}
     \norm{\linop(\Delta \eta, \Delta \phi)}_2.
%
\end{align*}
%
Formally, $\Delta \eta$ and $\Delta \phi$ are members of $\mathbb{R}^\etadim$
and $\linf$ respectively, but in the preceding display they can be thought of as
directions on which the linear operator $\linop$ operates.

Observe that the directional derivatives are linear operators, and so
$\norm{\cdot}^*$ defines a norm on the space of linear operators. We will prove
Fr{\'e}chet differentiability using the fact that a functional is Fr{\'e}chet
differentiable if its directional derivatives are continuous in $\norm{\cdot}^*$
as a function of the location at which they are evaluted  (see
\citet[Proposition 4.8(c)]{zeidler:2013:functional}, \citet[Corollary
1.4]{averbukh:1967:theory} and \citep[Appendix A]{reeds:1976:thesis}). Further,
it suffices by \citet[Proposition 4.14(c)]{zeidler:2013:functional} to show that
the partial derivatives with respect to $\eta$ and $\phi$ are Fr{\'e}chet to
show that the joint map is Fr{\'e}chet differentiable.

Recall that, by \lemref{exchange_order_q_suffices}, \lemref{logq_continuous}
applies with $\ptil(\theta \vert \t) = \phi(\theta)$ (no $\t$ dependence).

%%%%%%%
% eta

First, consider the partial derivative with respect to $\eta$.  The
linear operator corresponding to the directional derivative in the
$\Delta \eta$ direction is given by
%
\begin{align*}
%
\linop_\eta(\Delta \eta, \Delta \phi) =
    \fracat{\partial^2 \expect{\q(\theta \vert \eta)}{\phi(\theta)}}
           {\partial \eta \partial\eta^T}{\eta} \Delta \eta,
%
\end{align*}
%
with no dependence on $\Delta \phi$.  Define for the moment the the $\etadim
\times \etadim$ matrix $\mathscr{H}(\eta, \phi) := \partial^2 \expect{\q(\theta
\vert \eta)}{\phi(\theta)} / \partial \eta \partial \eta^T$.  Then the dual norm
of the derivative is simply the operator norm of $\mathscr{H}$, i.e.,
$\norm{\linop_\eta}^* = \norm{\mathscr{H}(\eta, \phi)}_{op}$. Thus we must show
that $\norm{\mathscr{H}(\eta, \phi)}_{op}$ is continuous in $\eta, \phi$.  For
any $\eta', \phi'$ and $\eta'', \phi''$ in $\ball_\eta \times
\ball_\phi(\delta)$,
%
\begin{align*}
%
\MoveEqLeft
\norm{\mathscr{H}(\eta', \phi') - \mathscr{H}(\eta'', \phi'')}_{op} \\
&\le
\norm{\mathscr{H}(\eta', \phi') - \mathscr{H}(\eta', \phi'')}_{op} +
\norm{\mathscr{H}(\eta', \phi'') - \mathscr{H}(\eta'', \phi'')}_{op}.
%
\end{align*}
%
For the first term in the preceding display, for all $\eta'$,
%
\begin{align*}
%
\norm{\mathscr{H}(\eta', \phi') - \mathscr{H}(\eta', \phi'')}_{op}
    \le{}&
    \fracat{\partial^2 \expect{\q(\theta \vert \eta)}{1}}
           {\partial \eta \partial\eta^T}{\eta'} \norminf{\phi' - \phi''}
           \Rightarrow\\
\lim_{\phi' \rightarrow \phi''}
\norm{\mathscr{H}(\eta', \phi') - \mathscr{H}(\eta', \phi'')}_{op} ={}& 0.
%
\end{align*}
%
For the second term, by \lemref{logq_continuous}, for all $\phi''$,
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta''}
    \norm{\mathscr{H}(\eta', \phi'') - \mathscr{H}(\eta'', \phi'')}_{op} = 0.
%
\end{align*}
%
It follows that $\norm{\mathscr{H}(\eta, \phi)}_{op}$ is continuous in $\eta,
\phi$, and so the partial derivative with respect to $\eta$ is
a continuous Fr{\'e}chet derivative.

%%%%%%%
% phi

Next, we consider the partial derivative with respect to $\phi$.  By \eqref{q_sens_is_cov}, we can write
%
\begin{align*}
%
\fracat{\partial \expect{\q(\theta \vert \eta)}{\phi(\theta)}}
       {\partial \eta}{\eta}
={}
\expect{\q(\theta \vert \eta)}
       {\lqgradbar{\theta \vert \eta} \phi(\theta)}.
%
\end{align*}
%
Since this expression is linear in $\phi$, the linear operator for the partial
derivative with respect to $\phi$ is given by
%
\begin{align*}
%
\linop_\phi(\Delta \eta, \Delta \phi) =
    \expect{\q(\theta \vert \eta)}
           {\lqgradbar{\theta \vert \eta} \Delta \phi(\theta)},
%
\end{align*}
%
with no dependence on $\Delta \eta$.

In order to be a valid partial derivaive, we must verify that $\linop_\phi$ is a
bounded linear operator.  Boundedness follows from H{\"o}lder's inequality and
\assuref{exchange_order_q} since
%
\begin{align*}
%
\sup_{\Delta\phi: \norminf{\Delta\phi} \le 1}
    \norm{\linop_\phi(\Delta \eta, \Delta \phi)}_2
\le{}&
\expect{\q(\theta \vert \eta)}
       {\norm{\lqgradbar{\theta \vert \eta}}_1} \norminf{\Delta \phi}
\\\le{}&
\sqrt{\etadim}\expect{\q(\theta \vert \eta)}
       {\norm{\lqgradbar{\theta \vert \eta}}_2}
\\\le{}&
\sqrt{\etadim} \int M(\theta) \mu(d\theta) < \infty.
%
\end{align*}

Similarly, the dual norm of the $\phi$ partial derivative is given by
%
\begin{align*}
%
\norm{\linop_\phi}^* ={}& \expect{\q(\theta \vert \eta)}
       {\norm{\lqgradbar{\theta \vert \eta}}_1}.
%
\end{align*}
%
We thus need to show that $\eta \mapsto \expect{\q(\theta \vert \eta)}
{\norm{\lqgradbar{\theta \vert \eta}}_1}$ is a continuous function of $\eta$
(there is no $\phi$ dependence).  To show this, observe that
%
\begin{align}
%
\expect{\q(\theta \vert \eta)}
       {\norm{\lqgradbar{\theta \vert \eta}}_1} ={}&
\frac{\int \qtil(\theta \vert \eta)
           \norm{\lqgradbar{\theta \vert \eta}}_1 \mu(d\theta)}
     {\int \qtil(\theta \vert \eta) \mu(d\theta)}.
    \eqlabel{phi_partial_dual}
%
\end{align}
%
By \assuref{exchange_order_q}, we have that there exists a finitely integrable
envelope function $M(\theta)$ such that, for all $\eta \in \ball_\eta$,
%
\begin{align*}
%
\qtil(\theta \vert \eta) \le{}& M(\theta) \mathand \\
\qtil(\theta \vert \eta)
           \norm{\lqgradbar{\theta \vert \eta}}_1
    \le{}&
\sqrt{\etadim} \qtil(\theta \vert \eta)
           \norm{\lqgradbar{\theta \vert \eta}}_2
           \le{} M(\theta).
%
\end{align*}
%
Therefore, by the dominated convergence theorem, we can exchange limits and
integrals in the numerator and denominator of \eqref{phi_partial_dual}.  It
follows that, for any $\eta'$ and $\eta''$ in $\ball_\eta$,
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta''}
\abs{\int \qtil(\theta \vert \eta') \mu(d\theta) -
     \int \qtil(\theta \vert \eta'') \mu(d\theta)}
\le{}&
\lim_{\eta' \rightarrow \eta''}
\int  \abs{\qtil(\theta \vert \eta') - \qtil(\theta \vert \eta'')}
\mu(d\theta)
\\={}&
\int \lim_{\eta' \rightarrow \eta''}  \abs{
\qtil(\theta \vert \eta') - \qtil(\theta \vert \eta'')
}
={} 0.
%
\end{align*}
%
Thus the numerator of \eqref{phi_partial_dual} is continuous in $\eta$. The
denominator of \eqref{phi_partial_dual} is also conitnuous by an analogous
argument.  Since the denominator of \eqref{phi_partial_dual} is bounded away
from zero, $\expect{\q(\theta \vert \eta)} {\norm{\lqgradbar{\theta \vert
\eta}}_1}$ is a continuous composition of continuous functions, and itself
continuous.  It follows that the $\phi$ partial derivative is
continuously Fr{\'e}chet differentiable.

Since its partial derivatives are continuous, it follows by \citet[Proposition
4.14(c)]{zeidler:2013:functional} that the joint map $\eta, \phi \mapsto
\partial \expect{\q(\theta \vert \eta)}{\phi(\theta)} / \partial \eta$ is
continously Fr{\'e}chet differentiable.

\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Proof of eta_phi_deriv

\prooflabel{eta_phi_deriv}\proofof{\thmref{eta_phi_deriv}}
%
Recall that, by \lemref{exchange_order_q_suffices}, \lemref{logq_continuous}
applies with $\ptil(\theta \vert \t) = \phi(\theta)$ (no $\t$ dependence).
Therefore, as in the proof of \thmref{etat_deriv}, for any $\phi \in \ball_\phi(\delta)$, $\etaopt(\phi)$ satisfies the first-order condition
%
\begin{align}\eqlabel{vb_first_order_condition_phi}
%
\fracat{\partial \KL{\eta}}{ \partial \eta}{\etaopt(\phi)} +
\fracat{\partial
    \expect{\q(\theta \vert \eta)}{\phi(\theta)}}
    {\partial \eta}
    {\etaopt(\phi)}
={} 0.
%
\end{align}

As in the proof of \thmref{etat_deriv}, we wish to employ an implicit
function theorem, but this time for general Banach spaces.  We will
us \citet[Theorem 4.B]{zeidler:2013:functional}.

First, \citet[Chapter 4 Condition 21b]{zeidler:2013:functional} holds since
$\KLhess{\etaopt(\phiz), \phiz}$ is invertible by
\assuitemref{kl_opt_ok}{kl_hess}.   So we satisfy conditions (i), (ii), and
(iii) of \citet[Theorem 4.B(c)]{zeidler:2013:functional}, giving that the
function $\etaopt(\phi)$ exists.

Moreover, by \assuitemref{kl_opt_ok}{kl_diffable} and
\lemref{objective_is_frechet}, the estimating equation
\eqref{vb_first_order_condition_phi} is continuously Fre{\'e}chet differentiable
($C^1$ in the notation of Zeidler) in a neighborhood of $\etaopt(\phiz), \phiz$.
It follows from \citet[Theorem 4.B(d)]{zeidler:2013:functional}, $\etaopt(\phi)$
is also continuously Fr{\'e}chet differentiable.

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{continuity_partition}
%
Let $\epsilon'_n = n^{-1}$.  Since $\pbase \ll \mu \ll \lambda$ (where $\lambda$
is the Lebesgue measure), by applying \citet[Proposition
15.5]{nielsen:1997:measure}, for each $n$ there exists a $\delta'_n$ such that,
for any measureable set $A$ with $\mu(A) < \delta'_n$, $\pbase(A) <
\epsilon'_n$.  Again applying \citet[Proposition 15.5]{nielsen:1997:measure},
there similarly exists a $\delta_n$ such that for any measureable set $A$ with
$\lambda(A) < \delta_n$, $\mu(A) < \delta'_n \Rightarrow \pbase(A) <
\epsilon'_n$.

For each $n$, partition $\thetadom$ into a countable number of sets $A_{m}$ such
that $\sum_{m} \lambda(A_{m}) = 1$ and $\lambda(A_{m}) < \delta_n$. (This is
possible by dividing $\thetadom$ into sufficiently small rectangles, for
example.)  Then $\pbase(A_{m}) < \epsilon'_n$ for all $m$.  Since $\pbase$ is a
probability measure, $\sum_m \pbase(A_{m}) = 1$, so there must exist at least $1 /
\epsilon'_n$ indices $m'$ such that $\pbase(A_{m'}) > 0$. Take any such $m'$ and
let $\epsilon_n = \pbase(A_{m'})$ and $S_n = A_{m'}$.

%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lem}\lemlabel{normal_q_is_regular}
%
Let $\mu$ denote the Lebesgue measure on $\mathbb{R}$. Let $\sigma$ denote the
standard deviation of a normal distribution, let $\eta$ denote a continuously
differentiable function of the normal distribution's natural parameters, let
$\normdist{\theta \vert \eta}$ denote a normal density with respect to $\mu$,
and let $\ball_\eta$ denote an open ball in $\mathbb{R}^2$ such that $0 < \sigma <
\infty$ for all $\eta \in \ball_\eta$.
%
Let $\ball_\t$ denote an open ball in $\mathbb{R}$, and let $\psi(\theta, \t)$
be a function such that $\theta \mapsto \psi(\theta, \t)$ is $\mu$-measurable
for all $\t \in \ball_\t$.

If there exists a constant $C > 0$ such that
%
\begin{align*}
%
\sup_{\t \in \ball_\t} \abs{\psi(\theta, \t)}
    \le C \exp(\abs{\theta})
\mathand
\sup_{\t \in \ball_\t}
    \abs{\frac{\partial \psi(\theta, \t)}{\partial \t}}
    \le C \exp(\abs{\theta}),
%
\end{align*}
%
then one can exchange the order of expectation and differentation in the
expression $\expect{\normdist{\theta \vert \eta}}{\psi(\theta, \t)}$ for the
derivatives $\partial / \partial \eta$, $\partial^2 / \partial \eta \partial
\eta$, and $\partial^2 / \partial \eta  \partial \t$, eavluated at any $\t \in
\ball_\t$ and $\eta \in \ball_\eta$.

\begin{proof}
% \proofof{\lemref{normal_q_is_regular}}
% \prooflabel{normal_q_is_regular}
%
For the moment, let $\eta$ denote the exponential family natural parameters of
the normal distribution. By properties of the exponential family,
%
\begin{align*}
%
\lqgrad{\theta \vert \eta} ={} (\theta, \theta^2)^T \mathand&
\lqhess{\theta \vert \eta} ={} 0_{2\times2} \Rightarrow\\
%
\norm{\lqgrad{\theta \vert \eta}}_2^2 ={} \theta^2 + \theta^4 \mathand&
\norm{\lqhess{\theta \vert \eta}}_2 ={} 0.
%
\end{align*}
%
Let $\ballclosed_\eta$ denote the closure of $\ball_\eta$, and let
%
\begin{align*}
%
\eta^* := \argmax_{\eta \in \ballclosed_\eta}
    \expect{\q(\theta \vert \eta)}{\exp(\abs{\theta})}.
%
\end{align*}
%
By standard properties of the normal and the boundedness of $\sigma(\eta)$, the
right hand side of the preceding display is finite.
%
Then
%
\begin{align*}
\int \q(\theta \vert \eta) \psi(\theta, \t) \mu(d \theta) \le{}&
    \left( \sup_{\theta} \sup_{\t \in \ball_\t}
        \abs{\psi(\theta, \t)} \exp(-\abs{\theta}) \right)
    \int \q(\theta \vert \eta) \exp(\theta) \mu(d \theta)
%
\\\le{}&
    \const
    \expect{\q(\theta \vert \eta^*)}{\exp(\abs{\theta})}.
    \quad\constdesc{\eta, \t}
%
\end{align*}
%
Therefore, for \assuref{exchange_order_f}, we can take $M(\theta)
\propto \q(\theta \vert \eta^*) \exp(\abs{\theta})$. The other terms follow
similarly, since each multiplier of $\q(\theta \vert \eta)$ is dominated by
$\exp(-\abs{\theta})$.  The final $M(\theta)$ simply takes the largest
of the five constants.

Finally, if $\tilde{\eta}$ is a twice-continuously differentiable function of
the natural parameters $\eta$ (e.g the mean and variance), then the derivatives
with respect to $\tilde{\eta}$ are equal to the derivatives with respect to
$\eta$ times bounded (on $\ball_\eta$) functions of $\eta$ that do not depend on
$\theta$. Thus a constant multiple of $M(\theta)$ will bound the new
derivatives.
%
\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
