
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\proofof{\lemref{normal_q_is_regular}}
\prooflabel{normal_q_is_regular}
%
TODO: update this so that $\eta$ is actually the mean and variance.

By properties of the exponential family,
%
\begin{align*}
%
\lqgrad{\theta \vert \eta} ={} (\theta, \theta^2)^T \mathand&
\lqhess{\theta \vert \eta} ={} 0_{2\times2} \Rightarrow\\
%
\norm{\lqgrad{\theta \vert \eta}}_2^2 ={} \theta^2 + \theta^4 \mathand&
\norm{\lqhess{\theta \vert \eta}}_2 ={} 0.
%
\end{align*}
%
Let $\ballclosed_\eta$ denote the closure of $\ball_\eta$, and let
%
\begin{align*}
%
\eta^* := \argmax_{\eta \in \ballclosed_\eta}
    \expect{\q(\theta \vert \eta)}{\exp(\abs{\theta})}.
%
\end{align*}
%
By standard properties of the normal and the boundedness of $\sigma(\eta)$, the
right hand side of the preceding display is finite.
%
Then
%
\begin{align*}
\int \q(\theta \vert \eta) \psi(\theta, \t) \mu(d \theta) \le{}&
    \left( \sup_{\theta} \sup_{\t \in \ball_\t}
        \abs{\psi(\theta, \t)} \exp(-\abs{\theta}) \right)
    \int \q(\theta \vert \eta) \exp(\theta) \mu(d \theta)
%
\\\le{}&
    \const
    \expect{\q(\theta \vert \eta^*)}{\exp(\abs{\theta})}.
    \quad\constdesc{\eta, \t}
%
\end{align*}
%
Therefore, for \assuitemref{dist_fun_nice}{fundom}, we can take $M(\theta)
\propto \q(\theta \vert \eta^*) \exp(\abs{\theta})$. The other terms follow
similarly, since each multiplier of $\q(\theta \vert \eta)$ is dominated by
$\exp(-\abs{\theta})$.  The final $M(\theta)$ simply takes the largest
of the five constants.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\prooflabel{etat_deriv}
\proofof{\thmref{etat_deriv}}
%
For the duration of the proof, define
%
\begin{align*}
%
\rho(\eta, \t) :={}&
    \expect{\q(\theta \vert \eta)}
           {\log \p(\theta \vert \t) - \log \p(\theta \vert 0)}
\mathand\\
\rho_\eta(\eta, \t) :={}&
\fracat{\partial \rho(\eta, \t)}
       {\partial \eta}{\eta}.
%
\end{align*}
%
Expanding $\logp(\theta \vert \t)$ in \eqref{vb_optimization}, we see that
%
\begin{align}
%
% \logp(\theta \vert \t) ={}& \logp(\theta) +
%     \log \p(\theta\vert\t) - \log \p(\theta \vert 0) \Rightarrow \nonumber\\
\KL{\eta, \t} ={}&
    \KL{\eta, 0} + \rho(\eta, \t). \eqlabel{kl_pert}
%
\end{align}
%
% We thus see that the optimization objective $\KL{\eta, \t}$ is the original
% optimization obejctive, $\KL{\eta, 0}$, plus the additive term $\rho(\eta,
% \t)$ depending only on $\eta$ and $\t$.
%
By \lemref{logq_derivs}, $\eta \mapsto \rho(\eta, \t)$ is continuous, and
by \lemref{logq_continuous} $\eta \mapsto \rho(\eta, \t)$ is continuously
differentiable, for all $\eta, \t \in \ball$.  So $\partial \KL{\eta, \t}  /
\partial \eta$ is continuous for all $\eta, \t \in \ball$ and, by the
first-order condition, $\etaopt(\t)$ satisfies
%
\begin{align}\eqlabel{vb_first_order_condition}
%
\fracat{\partial \KL{\eta, \t}}{ \partial \eta}{\etaopt(\t), \t} ={}
\fracat{\partial \KL{\eta, 0}}{ \partial \eta}{\etaopt(\t)}
+  \rho_\eta(\etaopt(\t), \t) ={} 0
%
\end{align}
%
for all $\t \in \ball_\t$.

We wish to apply the implicit function theorem to
\eqref{vb_first_order_condition}, for which we must show that $\partial
\KL{\eta, \t} / \partial \eta$ is continuously differentiable in both $\eta$ and
$\t$.  By \assuitemref{kl_opt_ok}{kl_diffable}, $\partial \KL{\eta, 0} /
\partial \eta$ is continuously differentiable, so we need only consider
$\rho_\eta(\theta, \t)$.

By \lemref{logq_continuous} and (Q STICK REGULAR), we
have that both $\partial \rho_\eta(\eta, \t) / \partial \eta$ and $\partial
\rho_\eta(\eta, \t) / \partial \t$ are continuous in both $\eta$ and $\t$.
Since both its partial derivatives are continuously differentiable, the joint
map $\eta, \t \mapsto \rho_\eta(\eta, \t)$ is also continuously differentiable
(e.g., \citet[Theorem 3.2]{fleming:2012:functions}).  Consequently, $\partial
\KL{\eta, \t} / \partial \eta$ is continuously differentiable in both $\eta$ and
$\t$.

% This does not appear to be necessary.
% Since $\rho_\eta(\eta, \t)$ is continuously differentiable, $\KLhess{\eta, \t}$
% is continuous, and since $\KLhess{\etaopt, 0}$ is positive definite,
% $\KLhess{\eta, \t}$ is positive definite for all $\eta, \t \in \ball$.

Together with \assuitemref{kl_opt_ok}{kl_hess}, which gives that $\partial^2
\KL{\eta, \t} / \partial \eta \partial\eta^T$ is invertible at $\etaopt$, the
result then follows from the implicit function theorem \citet[Theorem
3.3.1]{krantz:2012:implicit}. For convenience, \tabref{kranz_notation} shows the
correspondence between their notation and ours.
% Note
% that we make the following formal identifications with the notation of
% \citet[Theorem 3.3.1]{krantz:2012:implicit}:

\begin{center}
\begin{tabular}{|c|c|}
%
\hline Krantz \& Parks notation & Our notation \\\hline
$\Phi(x)$                       & $\KL{\eta, \t}$ \\\hline
$Q$                             & $1$ \\\hline
$M$                             & $\etadim$ \\\hline
$U$                             & $\ball$ \\\hline
$W$                             & $\ball_\t$ \\\hline
$x_1,\ldots,x_Q$                & $\t$ \\\hline
$x_{Q+1},\ldots,x_N$            & $\eta$ \\\hline
$f_1(x_a), \ldots,f_M(x_a)$     & $\etaopt(\t)$ \\\hline
%Equation 3.32                   & \assuitemref{kl_opt_ok}{kl_hess} \\\hline
%
\end{tabular}\tablabel{kranz_notation}
\end{center}

The form of the derivative is given by combining \eqref{kl_pert} with
\eqref{q_sens_psi_grad_is_cov} of \lemref{logq_derivs}, since
%
\begin{align*}
%
\fracat{\partial^2 \KL{\eta, \t}}
       {\partial \eta \partial \t}
       {\etaopt, 0} =
\expect{\q(\theta \vert \etaopt)}{
    \lqgradbar{\theta \vert \etaopt}
    \fracat{\partial \log \p(\theta \vert \t)}{\partial \t}{\t=0}
}.
%
\end{align*}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\prooflabel{pert_invariance}\proofof{\lemref{pert_invariance}}
%
\todo{Put the proof of Linfty validity in here too.}

Let $\mu$ and $\mu'$ denote two mutually absolutely continuous candidate
dominating measures for $\pbase$, with respective densities (Radon-Nikodym
derivatives) $\pbase(\theta)$ and $\pbase'(\theta)$.  Let the respective
densities of the measure $\p$ be denoted $\palt(\theta)$ and $\palt'(\theta)$ as
well.  Let $R(\theta) = \fracat{d\mu}{d\mu'}{\theta}$ denote the Radon-Nikodym
derivative of $\mu$ with respect to $\mu'$, and note that $\pbase'(\theta) =
R(\theta) \pbase(\theta)$ and $\palt'(\theta) = R(\theta) \palt(\theta)$.

We have that the perturbations for $\mu$ and $\mu'$ are given respectively by
%
\begin{align*}
%
\phi(\theta \vert \beta, \palt) ={}&
  \log \palt(\theta) - \log \pbase(\theta) + \log \beta \\
\phi'(\theta \vert \beta, \palt') ={}&
    \log \palt'(\theta) - \log \pbase'(\theta) + \log \beta
\\={}&
\log \palt(\theta) - \log R(\theta)
    - \log \pbase(\theta) + \log R(\theta)+ \log \beta
\\={}&
\phi(\theta \vert \beta, \palt).
%
\end{align*}
%
It follows that $\norminf{\phi(\cdot \vert \beta, \palt)} = \norminf{\phi'(\cdot
\vert \beta, \palt')}$.

Next, let $\tau := \tau(\theta)$ be an invertible transformation with Jacobian
$J(\theta) := \mathrm{det}\left(\fracat{d\tau}{d\theta^T}{\theta}\right)$. For
the dominating measure $\mu$, let $\pbase(\theta)$ and $\palt(\theta)$ denote
the densities of $\theta$ and $\pbase'(\tau)$ and $\palt'(\tau)$ denote the
densities of $\tau$.  The desired result follows by the exact same formal
argument as for the change of measure, except with $J(\theta) \mu(d\theta)$
and $\mu(d\tau)$ taking the place of $R(\theta) \mu(d\theta)$ and
$\mu'(d\theta)$, respectively.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Proof of eta_phi_deriv

\prooflabel{eta_phi_deriv}\proofof{\thmref{eta_phi_deriv}}
%
The map $\eta, \phi \mapsto \KL{\eta, \phi}$ is a map from the Banach space
$\mathbb{R}^\etadim \times \linf$ into the Banach space $\mathbb{R}$. Let us
take the L2 norm $\norm{\cdot}_2$ on $\mathbb{R}^{\etadim}$ and $\mathbb{R}$.
Let $\ball$ denote the ball $\ball_\eta \times \{ \phi: \norminf{\phi} <
\delta\}$ for some $\delta > 0$.  Let $\linop$ denote a linear operator from
$\ball$ to $\mathbb{R}^\etadim$, and define the dual norm
%
\begin{align*}
%
\norm{\linop}^* :=
    \sup_{\eta: \norm{\eta}_2 \le 1} \sup_{\phi: \norminf{\phi} \le 1}
     \norm{\linop(\eta, \phi)}_2.
%
\end{align*}

For any $\phi \in \ball_\phi$, observe that $\t \mapsto \pstick(\zeta \vert \t
\phi)$ satisfies (Q STICK REGULAR) under (Q FUN STICK REGULAR),
since, for any $f(\nu)$, $\lambda$-almost surely,
%
\begin{align*}
%
f(\nu) \phi(\nu) \le f(\nu) \norminf{\phi} \le \norminf{\phi} M(\nu).
%
\end{align*}
%
So, by \lemref{logq_continuous}, $\eta \mapsto \partial \KL{\eta, \phi} /
\partial \eta$ is continuous for any $\phi \in \ball_\phi$, and by a first-order
condition $\etaopt(\phi)$ satisfies
%
\begin{align*}
%
\fracat{\partial \KL{\eta, \phi}}
                {\partial \eta}
                {\etaopt(\phi)} = 0.
%
\end{align*}
%
Using this estimating equation, the key to the proof will be the implicit
function theorem for Banach spaces. To use the implicit function theorem, we
need to show that $\KLgrad{\eta, \phi}$ is continuously Fr{\'e}chet
differentiable at $\etaopt, \phiz$.

%  and that $\KLhess{\eta, \phi}$ is positive
% definite in $\ball$.  --- is the actually needed?

For the duration of the proof, define
%
\begin{align*}
%
\rho(\etanuk, \phi) :={}&
    \expect{\q(\nu \vert \etanuk)}{\phi(\etanuk)}
\mathand\\
\rho_\eta(\etanuk, \phi) :={}&
    \fracat{\partial \rho(\etanuk, \phi)}{\phi(\etanuk)}.
%
\end{align*}
%
Expanding $\logp(\zeta \vert \phi)$ in \eqref{vb_optimization}, we see that
%
\begin{align}
\fracat{\partial \KL{\eta, \phi}}{\partial \eta}{\eta, \phi}
 ={}&
    \fracat{\partial \KL{\eta, \phiz}}{\partial \eta}{\eta} +
    \sumkm \rho_\eta(\etanuk, \phi). \eqlabel{kl_fun_pert}
%
\end{align}
%
By \assuref{kl_opt_ok}, $\partial \KL{\eta, \phiz} / \partial \eta$ is
continuously Fr{\'e}chet differentiable (it does not depend on $\phi$), so we
need consider only $\etanuk, \phi \mapsto \rho_\eta(\etanuk, \phi)$.  As
in the proof of \thmref{etat_deriv}, we will show continuous differentiability
by showing that the partial derivatives in the $\eta$ and $\phi$ directions
are continuous, this time in the dual norm $\norm{\cdot}^*$.

Let us first consider the partial derivative of $\rho_\eta(\etanuk, \phi)$ in
the $\eta$ direction. By \lemref{logq_derivs} \eqref{q_score_sens_is_cov},
%
\begin{align*}
%
\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} ={}&
\expect{\q(\nuk \vert \etanuk)}{
   \lqhessbar{\nuk \vert \etanuk}
       \left(
        \phi(\nuk) - \expect{\q(\nuk \vert \etanuk)}{\phi(\nuk)}
       \right)
       }.
%
\end{align*}
%
We need to show that the preceding expression is continuous in the dual norm
$\norm{\cdot}^*$.  The linear operator acts only in the $\eta$ direction, so
the dual norm is equivalent to operator norm $\normop{\cdot}$.  Since
the preceding display is linear in $\phi$,

%
\begin{align*}
%
\MoveEqLeft
%
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
      }^* \\ \le
%
& \norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
        \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi'}
    }^* + \\&\quad
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi'} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
    }^* \\ \le
%
& \normop{
    \expect{\q(\nuk \vert \etanuk)}
           {\lqhessbar{\nuk \vert \etanuk}}
    } \norminf{\phi - \phi'} + \\&\quad
\normop{
    \expect{\q(\nuk \vert \etanuk)}{\lqhessbar{\nuk \vert \etanuk}} -
    \expect{\q(\nuk \vert \etanuk')}{\lqhessbar{\nuk \vert \etanuk'}}
  } \norminf{\phi'}.
%
\end{align*}
%
Since continuity in $\norm{\cdot}_2$ implies continuity in $\normop{\cdot}$,
the preceding display and \lemref{logq_continuous} gives that
$\partial \rho_\eta(\etanuk, \phi) / \partial \etanuk$ is continuous,
since
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta} \lim_{\phi' \rightarrow \phi}
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
      }^* = 0.
%
\end{align*}

Next, we consider the partial derivative in the direction $\phi$.  Observing
that $\rho_\eta(\etanuk, \phi)$ is in fact linear in $\phi$, we see that the
partial derivative in the $\phi$ direction is given by the linear map
%
\begin{align}\eqlabel{rho_phi_partial}
%
\fracat{\partial \rho_\eta(\etanuk, \phi)}
       {\partial \phi}{\eta, \phi} \phi =
    \rho_\eta(\etanuk, \phi).
%
\end{align}
%
By \lemref{logq_derivs} \eqref{q_sens_is_cov},
%
\begin{align}\eqlabel{rho_phi_partial_cov}
%
\rho_\eta(\etanuk, \phi) ={}&
\expect{\q(\nuk \vert \etanuk)}
       {\lqgradbar{\nuk \vert \etanuk} \left(
        \phi(\nuk) - \expect{\q(\nuk \vert \etanuk)}{\phi(\nuk)}
       \right)
       }.
%
\end{align}
%
Note that
%
\begin{align*}
%
\sup_{\phi: \norminf{\phi} \le 1} \norm{\rho_\eta(\etanuk, \phi)}_2 \le{}&
    2 \expect{\q(\nuk \vert \etanuk)}
             {\norm{\lqgradbar{\nuk \vert \etanuk}}_2
             },
%
\end{align*}
%
so that $\phi \mapsto \rho_\eta(\etanuk, \phi)$ is a bounded linear operator and
so a valid derivative.

We now need to show continuity of the map of $\eta, \phi \mapsto
\rho_\eta(\etanuk, \phi)$ in the dual norm $\norm{\cdot}^*$.  Obviously the
linear map does not depend on the location $\phi$ at which it is evaluated, so
we need consider only continuity in $\eta$.  The linear map is zero in the
$\eta$ direction, so the dual norm is given by
%
\begin{align*}
%
\MoveEqLeft
\norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}^* \\={}&
\sup_{\phi: \norminf{\phi} \le 1}
    \norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}_2 \\\le{}&
4 \norm{
    \expect{\q(\nuk \vert \etanuk')}{\lqgradbar{\nuk \vert \etanuk'}} -
    \expect{\q(\nuk \vert \etanuk')}{\lqgradbar{\nuk \vert \etanuk}}
}_2.
%
\end{align*}
%
Applying \lemref{logq_continuous} to the preceding display gives
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta}
    \norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}^* = 0,
%
\end{align*}
%
and so $\partial \rho_\eta(\eta, \phi) / \partial \phi$ is a bounded linear
function, continuous in the point at which it is evaluated, and so $\phi \mapsto
\rho_\eta(\eta, \phi)$ is continuously Fr{\'e}chet differentiable.

Since its partial derivatives are continuous, it follows by \citet[Proposition
4.14(c)]{zeidler:2013:functional} that the joint map $\eta, \phi \mapsto
\partial \KL{\eta, \phi} / \partial \eta$ is continously Fr{\'e}chet
differentiable.  Furthermore, \citet[Chapter 4 Condition
21b]{zeidler:2013:functional} holds since $\KLhess{\etaopt(\phiz), \phiz}$ is
invertible by \assuitemref{kl_opt_ok}{kl_hess}.   So we satisfy conditions (i),
(ii), and (iii) of \citet[Theorem 4.B(c)]{zeidler:2013:functional}, giving that
the function $\etaopt(\phi)$ exists.  Moreover, since we have shown that $\eta,
\phi \mapsto \partial \KL{\eta, \phi} / \partial \eta$ is continuously
Fre{\'e}chet differentiable ($C^1$ in the notation of Zeidler) in a neighborhood
of $\etaopt(\phiz), \phiz$, by \citet[Theorem 4.B(d)]{zeidler:2013:functional},
$\etaopt(\phi)$ is also continuously Fr{\'e}chet differentiable.

The form of the derivative is given by the directional derivatives $d \etaopt(\t
\phi) / d\t | \t = 0$, which, by \thmref{etat_deriv} and \eqref{rho_phi_partial,
rho_phi_partial_cov}, is given by
%
\begin{align*}
%
-\left(\fracat{\partial^2 \KL{\eta, \phiz}}
                {\partial \eta \partial \eta^T}
                {\etaopt}\right)^{-1}
\left(
    \sumkm \expect{\q(\nu \vert \etaoptnuk)}
                  {\lqgradbar{\nuk \vert \etanuk}
                   \phi(\nuk) }
\right).
%
\end{align*}
%
(Note that a general version of the same result is given immediately following
the statement of \citet[Theorem 4.B(c)]{zeidler:2013:functional}.)  In the last
line of the preceding display we have dropped the $\expect{\q(\nuk \vert
\etanuk)}{\phi(\nuk)}$ term since $\expect{\q(\nu \vert \etaoptnuk)}
{\lqgradbar{\nuk \vert \etanuk}} = 0$.  \Eqref{infl_defn} follows by
re-writing the preceding display as an integral.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
