
A standard consequence of the dominated convergence theorem is the ability to
exchange integration and differentiation.  Since we will use this result
frequently, we state it here in our own notation as \thmref{dct}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{thm}\thmlabel{dct}
\citep[Theorem 16.8]{billingsley:1986:probability}
%
Let $\mu$ be sigma-finite measure on $\thetadom$, and let $S_\t \subseteq
\mathbb{R}$.  Let $f:\thetadom \times S_\t \mapsto \mathbb{R}$.

If there exists a function $M(\theta)$ with $\int M(\theta) \mu(d\theta) <
\infty$ such that $\abs{f(\theta, \t)} \le M(\theta)$, $\mu$-almost surely,
for all $\t \in S_\t$, then the map $\t \mapsto \int f(\theta, \t)
\mu(d\theta)$ is continuous.

Further, suppose that the derivative $\fracat{\partial f(\theta, \t)}{\partial
\t}{\t}$ exist $\mu$-almost surely for $\t \in S_\t$.  If there exists
an $M'(\theta)$ such that $\int M'(\theta) \mu(d\theta) < \infty$ and
$\abs{\fracat{\partial f(\theta, \t)}{\partial \t}{\t}} \le M'(\theta)$,
$\mu$-almost surely and for all $\t \in S_\t$, then
%
\begin{align*}
%
\fracat{\partial \int f(\theta, \t) \mu(d\theta)}{\partial \t}{\t} =
     \int \fracat{\partial f(\theta, \t)}{\partial \t}{\t} \mu(d\theta).
%
\end{align*}
%
\end{thm}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\proofof{\lemref{exchange_order}}\prooflabel{exchange_order}

Let $\eta_d$ denote the $d-$th entry of the vector $\eta$.  Then
%
\begin{align*}
%
\abs{\partial f(\theta, \eta, \t) / \partial \eta_d} \le{}&
  \norm{\partial f(\theta, \eta, \t) / \partial \eta}_2
\textrm{,}\\
\abs{\partial^2 f(\theta, \eta, \t) / \partial \eta_d \partial \t} \le{}&
    \norm{\partial f(\theta, \eta, \t) / \partial \eta \partial \t}_2
\textrm{, and}\\
\abs{\partial^2 f(\theta, \eta, \t) /
       \partial \eta_{d_1} \partial \eta_{d_2}} \le{}&
     \norm{\partial f(\theta, \eta, \t) / \partial \eta \partial\eta^T}_2.
%
\end{align*}
%
The conclusion follows by repeatedly applying \thmref{dct} to the components
of the derivatives.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \begin{defn}
% %
% Throughout the appendix, use the following notation.
% %
% \begin{align*}
% %
% \lqgrad{\theta \vert \eta} :={}&
%     \fracat{\partial \log \qtil(\theta \vert \eta)}{\partial \eta}{\eta} \\
% %
% \lqhess{\theta \vert \eta} :={}&
%     \fracat{\partial^2 \log \qtil(\theta \vert \eta)}
%            {\partial \eta \partial \eta^T}{\eta} \\
% %
% \psi(\theta, \t) :={}&
%     \log \ptil(\theta \vert \t) - \log \ptil(\theta \vert \t=0)\\
% %
% \psigrad{\theta, \t} :={}&
%     \fracat{\partial \psi(\theta, \t)}{\partial \t}{\t} \\
% %
% \lqgradbar{\theta \vert \eta} :={}& \lqgrad{\theta \vert \eta}
%   - \expect{\q(\theta \vert \eta)}{\lqgrad{\theta \vert \eta}} \\
% %
% \lqhessbar{\theta \vert \eta} :={}& \lqhess{\theta \vert \eta}
%  - \expect{\q(\theta \vert \eta)}{\lqhess{\theta \vert \eta}}.
% %
% \end{align*}
% %
% \end{defn}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \begin{assu}\assulabel{dist_fun_nice}
% %
% \todo{What from here needs to be kept?}
%
%
% Assume that the map $\eta \mapsto \log \qtil(\theta \vert \eta)$ is twice
% continuously differentiable. Let $\psi(\theta, \t)$ be a scalar-valued
% $\mu$-measurable function of $\theta$ and $\t$.  Assume that the map $\t \mapsto
% \psi(\theta, \t)$ is continuously differentiable.
% %
% For a given $\t_0$ and $\eta_0$, assume there exists some neighborhood of
% $\t_0$, $\ball_\t$, some neighborhood of $\eta_0$, $\ball_\eta$, and a
% $\mu$-integrable $M_\psi(\theta)$ with $\int M_\psi(\theta) \mu(d\theta) <
% \infty$ such that the following bounds hold for all $\eta, \t \in \ball_\eta
% \times \ball_\t$:
% %
% \begin{enumerate}
% %
% \item \itemlabel{fundom}
% $\qtil(\theta \vert \eta) \psi(\theta, \t) \le M_\psi(\theta)$.
% %
% \item \itemlabel{funqgraddom}
% $\qtil(\theta \vert \eta) \norm{\lqgrad{\theta \vert \eta}}_2 \psi(\theta, \t) \le
% M_\psi(\theta)$.
% %
% \item \itemlabel{funqhessdom}
% $\qtil(\theta \vert \eta) \norm{\lqhess{\theta \vert \eta}}_2 \psi(\theta, \t) \le
% M_\psi(\theta)$.
% %
% \item \itemlabel{fungradqgraddom}
% $\qtil(\theta \vert \eta) \norm{\lqgrad{\theta \vert \eta}}_2 \psigrad{\theta, \t}
% \le M_\psi(\theta)$.
% %
% \item \itemlabel{funqgradsqdom}
% $\qtil(\theta \vert \eta) \norm{\lqgrad{\theta \vert \eta}}^2_2 \psi(\theta, \t) \le
% M_\psi(\theta)$.
% %
% \end{enumerate}
% %
% \end{assu}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \begin{lem}\lemlabel{logq_derivs}
% %
% Under \assuref{exchange_order}, the following equalties hold:
% %
% \begin{align}
% %
% \MoveEqLeft
% \fracat{\partial \expect{\q(\theta \vert \eta)}
%               {\psi(\theta, \t)}}{\partial \eta}{\eta}
% \nonumber\\ \quad={}&
% \expect{\q(\theta \vert \eta)}
%        {\lqgradbar{\theta \vert \eta} \left(
%         \psi(\theta,\t) - \expect{\q(\theta \vert \eta)}{\psi(\theta, \t)}
%        \right)
%        }\eqlabel{q_sens_is_cov}\\\nonumber\\
% %
% \MoveEqLeft
% \fracat{\partial^2 \expect{\q(\theta \vert \eta)}
%       {\psi(\theta, \t)}}{\partial \eta \partial \t}{\eta, \t}
% \nonumber\\ \quad={}&
%   \expect{\q(\theta \vert \eta)}
%          {\lqgradbar{\theta \vert \eta} \left(
%           \psigrad{\theta,\t} - \expect{\q(\theta \vert \eta)}{\psigrad{\theta, \t})}
%          \right)
%          } \eqlabel{q_sens_psi_grad_is_cov} \\\nonumber\\
%  %
%  \MoveEqLeft
%  \fracat{\partial^2 \expect{\q(\theta \vert \eta)}
%        {\psi(\theta, \t)}}{\partial \eta \partial \eta^T}{\eta}
% \nonumber\\={}&
%  \expect{\q(\theta \vert \eta)}
%         {\lqgradbar{\theta \vert \eta} \lqgradbar{\theta \vert \eta}^T
%         \left(
%          \psi(\theta,\t) - \expect{\q(\theta \vert \eta)}{\psi(\theta, \t)}
%         \right)
%         } +
% \nonumber\\ \quad&
%  \expect{\q(\theta \vert \eta)}{
%         \lqhessbar{\theta \vert \eta}
%         \left(
%          \psi(\theta,\t) - \expect{\q(\theta \vert \eta)}{\psi(\theta, \t)}
%         \right)
%         }. \eqlabel{q_score_sens_is_cov}
% %
% \end{align}
% %
% \begin{proof}
% %
% The proof follows by repeatedly using \thmref{dct} to interchange the order of
% integration and differentiation as in  \citep[Theorem
% 1]{giordano:2018:covariances}, from which \eqref{q_sens_is_cov} follows
% directly.  \Eqref{q_sens_psi_grad_is_cov} follows by applying
% \assuref{exchange_order} to \eqref{q_sens_is_cov}.
%
% To compute \eqref{q_score_sens_is_cov}, we differentiate \eqref{q_sens_is_cov}
% with respect to $\eta$, which involves terms of the form $\expect{\q(\theta
% \vert \eta)}{\lqgrad{\theta \vert \eta}}$ and $\expect{\q(\theta \vert
% \eta)}{\lqgrad{\theta \vert \eta} \psi(\theta, \t)}$.  For both of these terms,
% we can exchange the order of the expectation and differentiation by
% \assuref{exchange_order}.  \Eqref{q_score_sens_is_cov} then follows by
% differentiating and collecting terms.
% %
% \end{proof}
% %
% \end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{logq_continuous}

Under \assuref{exchange_order}, the map $\eta, \t \mapsto \expect{\q(\theta
\vert \eta)}{\ptil(\theta \vert \t)}$ has continuous partial derivatives
$\partial / \partial \eta$, $\partial^2 / \partial \eta^2$, and $\partial^2 /
\partial \eta \partial \t$ at all $\eta, \t \in \ball_\eta \times \ball_\t$.
Furthermore,

\begin{align}
\fracat{\partial \expect{\q(\theta \vert \eta)}
              {\ptil(\theta \vert \t)}}{\partial \eta}{\eta}
={}&
\expect{\q(\theta \vert \eta)}
       {\lqgradbar{\theta \vert \eta}
       \ptil(\theta \vert \t)}
       \eqlabel{q_sens_is_cov}\\
%
\fracat{\partial^2 \expect{\q(\theta \vert \eta)}
      {\ptil(\theta \vert \t)}}{\partial \eta \partial \t}{\eta, \t}
={}&
\expect{\q(\theta \vert \eta)}
       {\lqgradbar{\theta \vert \eta}
       \fracat{\partial \ptil(\theta \vert \t)}{\partial \t}{\t}}
\eqlabel{q_sens_psi_grad_is_cov}.
  % \expect{\q(\theta \vert \eta)}
  %        {\lqgradbar{\theta \vert \eta} \left(
  %         \psigrad{\theta,\t} - \expect{\q(\theta \vert \eta)}{\psigrad{\theta, \t})}
  %        \right)
  %        } \eqlabel{q_sens_psi_grad_is_cov} \\\nonumber\\
\end{align}

%
% each of the following functions
% are continuous on $\ball_\eta \times \ball_\t$.
% %
% \begin{align*}
% %
% \eta, \t \mapsto{}& \fracat{\partial
% \expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta}{\eta, \t}
% %
% \mathtxt{,}\\
% %
% \eta, \t \mapsto{}& \fracat{\partial^2
% \expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta \partial
% \t}{\eta, \t}
% %
% \mathtxt{, and}\\
% %
% \eta, \t \mapsto{}&  \fracat{\partial^2
% \expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta \partial
% \eta^T}{\eta}
% %
% \end{align*}
% %
%
\begin{proof}
%
We can write
%
\begin{align*}
%
R(a, b) :={} \frac{a}{b} \quad \Rightarrow
\expect{\q(\theta \vert \eta)}{\psi(\theta, \t)} ={}
R\left(\int \qtil(\theta \vert \eta) \psi(\theta, \t) \mu(d\theta),
  \int \qtil(\theta \vert \eta) \mu(d\theta)\right).
% \frac{\int \qtil(\theta \vert \eta) \psi(\theta, \t) \mu(d\theta)}
%      {\int \qtil(\theta \vert \eta) \mu(d\theta)}.
%
\end{align*}
%
If necessary, we can shrink $\ball_\eta$ so that the denominator $\int
\qtil(\theta \vert \eta) \mu(d\theta)$ is bounded below by a positive constant
for all $\eta \in \ball_\eta$.  With the denominator strongly positive, $R(a,b)$
is is a continuously differentiable function to all orders for all $\t, \eta \in
\ball_\t \times \ball_\eta$.  The desired results follow from
\assuref{exchange_order} by the chain rule.

\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
