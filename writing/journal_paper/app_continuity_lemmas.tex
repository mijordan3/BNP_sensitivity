

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{assu}\assulabel{dist_nice}
%
Let $\q(\zeta \vert \eta)$ be a density on the random variable $\zeta$
parameterized by $\eta$ defined relative to a dominating measure $\lambda$.
%
Define
%
\begin{align*}
%
\lqgrad{\zeta \vert \eta} :={}&
    \fracat{\partial \log \q(\zeta \vert \eta)}{\partial \eta}{\eta}
    \mathtxt{and}
%
\lqhess{\zeta \vert \eta} :={}&
    \fracat{\partial^2 \log \q(\zeta \vert \eta)}
           {\partial \eta \partial \eta^T}{\eta}.
%
\end{align*}
%
For a given $\eta_0$, assume there exists a $\ball_\eta$ be some neighborhood of
$\eta_0$ and $\lambda$-integrable $M(\zeta)$ with $\int M(\zeta) \lambda(d\zeta) <
\infty$ such that the following conditions hold.
%
\begin{enumerate}
%
\item  \itemlabel{qdiffable} The map $\eta \mapsto \log \q(\zeta \vert \eta)$
is twice continuously differentiable.
%
\item \itemlabel{qdom} For all $\eta \in \ball_\eta$, $\q(\zeta \vert \eta) \le
M(\zeta)$.
%
\item \itemlabel{qgraddom} For all $\eta \in \ball_\eta$, $\q(\zeta \vert \eta)
\norm{\lqgrad{\zeta \vert \eta}}_2 \le M(\zeta)$.
%
\item \itemlabel{qhessdom} For all $\eta \in \ball_\eta$, $\q(\zeta \vert \eta)
\norm{\lqhess{\zeta \vert \eta}}_2 \le M(\zeta)$.
%
\item \itemlabel{qgradsqdom} For all $\eta \in \ball_\eta$, $\q(\zeta \vert \eta)
\norm{\lqgrad{\zeta \vert \eta}}_2^2 \le M(\zeta)$.
%
\end{enumerate}
%
\end{assu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{assu}\assulabel{dist_fun_nice}
%
Let \assuref{dist_nice} hold, and let $\psi(\zeta, \t)$ be a scalar-valued
$\lambda$-measurable function of $\zeta$ and $\t$.  Define
%
\begin{align*}
%
\psigrad{\zeta, \t} := \fracat{\partial \psi(\zeta, \t)}{\partial \t}{\t}.
%
\end{align*}
%
For a given $\t_0$, assume
there exists a $\ball_\t$ be some neighborhood of $\t_0$ and
$\lambda$-integrable $M_\psi(\zeta)$ with $\int M_\psi(\zeta) \lambda(d\zeta) <
\infty$ such that the following conditions hold.
%
\begin{enumerate}
%
\item  \itemlabel{fundiffable} The map $\t \mapsto \psi(\zeta, \t)$ is
continuously differentiable.
%
\item \itemlabel{fundom} For all $\eta, \t \in \ball_\eta \times \ball_\t$,
$\q(\zeta \vert \eta) \psi(\zeta, \t) \le M_\psi(\zeta)$.
%
\item \itemlabel{funqgraddom} For all $\eta, \t \in \ball_\eta \times \ball_\t$,
$\q(\zeta \vert \eta) \norm{\lqgrad{\zeta \vert \eta}}_2 \psi(\zeta, \t) \le
M_\psi(\zeta)$.
%
\item \itemlabel{funqhessdom} For all $\eta, \t \in \ball_\eta \times \ball_\t$,
$\q(\zeta \vert \eta) \norm{\lqhess{\zeta \vert \eta}}_2 \psi(\zeta, \t) \le
M_\psi(\zeta)$.
%
\item \itemlabel{fungradqgraddom} For all $\eta, \t \in \ball_\eta \times \ball_\t$,
$\q(\zeta \vert \eta) \norm{\lqgrad{\zeta \vert \eta}}_2 \psigrad{\zeta, \t}
\le M_\psi(\zeta)$.
%
\item \itemlabel{funqgradsqdom} For all $\eta, \t \in \ball_\eta \times \ball_\t$,
$\q(\zeta \vert \eta) \norm{\lqgrad{\zeta \vert \eta}}^2_2 \psi(\zeta, \t) \le
M_\psi(\zeta)$.
%
\end{enumerate}
%
\end{assu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{logq_derivs}
%
Let \assuref{dist_nice, dist_fun_nice} hold.  Define
%
\begin{align*}
%
\lqgradbar{\zeta \vert \eta} :={}& \lqgrad{\zeta \vert \eta}
  - \expect{\q(\zeta \vert \eta)}{\lqgrad{\zeta \vert \eta}} \\
\lqhessbar{\zeta \vert \eta} :={}& \lqhess{\zeta \vert \eta}
 - \expect{\q(\zeta \vert \eta)}{\lqhess{\zeta \vert \eta}} \\
% \psibar{\zeta, \t} :={}& \psi(\zeta,\t)
%  - \expect{\q(\zeta \vert \eta)}{\psi(\zeta, \t)}\\
% \psigradbar{\zeta, \t} :={}& \psigrad{\zeta,\t}
% - \expect{\q(\zeta \vert \eta)}{\psigrad{\zeta,\t}}.
%
\end{align*}
%
Then the following equalties hold:
%
\begin{align}
%
\MoveEqLeft
\fracat{\partial \expect{\q(\zeta \vert \eta)}
              {\psi(\zeta, \t)}}{\partial \eta}{\eta} ={}
\expect{\q(\zeta \vert \eta)}
       {\lqgradbar{\zeta \vert \eta} \left(
        \psi(\zeta,\t) - \expect{\q(\zeta \vert \eta)}{\psi(\zeta, \t)}
       \right)
       }\eqlabel{q_sens_is_cov}\\\nonumber\\
%
\MoveEqLeft
\fracat{\partial^2 \expect{\q(\zeta \vert \eta)}
      {\psi(\zeta, \t)}}{\partial \eta \partial \t}{\eta, \t} ={}\nonumber\\&
  \expect{\q(\zeta \vert \eta)}
         {\lqgradbar{\zeta \vert \eta} \left(
          \psigrad{\zeta,\t} - \expect{\q(\zeta \vert \eta)}{\psigrad{\zeta, \t})}
         \right)
         } \eqlabel{q_sens_psi_grad_is_cov} \\\nonumber\\
 %
 \MoveEqLeft
 \fracat{\partial^2 \expect{\q(\zeta \vert \eta)}
       {\psi(\zeta, \t)}}{\partial \eta \partial \eta^T}{\eta} ={}
 \nonumber\\&
 \expect{\q(\zeta \vert \eta)}
        {\lqgradbar{\zeta \vert \eta} \lqgradbar{\zeta \vert \eta}^T
        \left(
         \psi(\zeta,\t) - \expect{\q(\zeta \vert \eta)}{\psi(\zeta, \t)}
        \right)
        } +
 \nonumber\\ &
 \expect{\q(\zeta \vert \eta)}{
        \lqhessbar{\zeta \vert \eta}
        \left(
         \psi(\zeta,\t) - \expect{\q(\zeta \vert \eta)}{\psi(\zeta, \t)}
        \right)
        }. \eqlabel{q_score_sens_is_cov}
%
\end{align}
%
\begin{proof}
%
The proof follows by repeatedly using the dominated convergence theorem (DCT) to
interchange the order of integration and differentiation as in \citep[Theorem
1]{giordano:2018:covariances}.  For example,
%
\begin{align*}
%
\MoveEqLeft
\fracat{\partial \int \q(\zeta \vert \nu) \psi(\zeta \vert \t) \lambda(d\zeta)}
       {\partial \eta}{\eta}
={}\\&
\int \fracat{\partial \q(\zeta \vert \nu) \psi(\zeta \vert \t) }
          {\partial \eta}{\eta} \lambda(d\zeta)={}
&\mathtxt{(\assuitemref{dist_nice}{qdom} and the DCT)}
\\&
\int \lqgrad{\zeta, \eta} \psi(\zeta \vert \t) \q(\zeta, \eta) \lambda(d\zeta) ={}
&\mathtxt{(\assuitemref{dist_nice}{qdiffable})}
\\&
\expect{\q(\zeta, \eta)}{\lqgrad{\zeta, \eta} \psi(\zeta \vert \t) }.
%
\end{align*}
%
Applying analogous reasoning to the denominator of
%
\begin{align*}
%
\expect{\q(\zeta \vert \eta)}{\psi(\zeta, \t)} =
\frac{\int \psi(\zeta, \t) \q(\zeta \vert \eta) \lambda(d\zeta)}
     {\int \q(\zeta \vert \eta) \lambda(d\zeta)}
%
\end{align*}
%
and applying the chain rule gives \eqref{q_sens_is_cov}.

Similarly, by applying \assuitemref{dist_fun_nice}{fundom} and the DCT
gives
%
\begin{align*}
%
\fracat{\partial \expect{\q(\zeta \vert \eta)}{\psi(\zeta \vert \eta)}}
       {\partial \t}{\t} ={}&
\expect{\q(\zeta \vert \eta)}{\psigrad{\zeta \vert \eta}}.
%
\end{align*}
%
Applying \assuitemref{dist_fun_nice}{funqgraddom} and the DCT gives
%
\begin{align*}
%
\fracat{\partial \expect{\q(\zeta \vert \eta)}
                        {\lqgrad{\zeta \vert \eta}\psi(\zeta \vert \eta)}}
       {\partial \t}{\t} ={}&
\expect{\q(\zeta \vert \eta)}
       {\lqgrad{\zeta \vert \eta} \psigrad{\zeta \vert \eta}},
%
\end{align*}
%
where we have used the fact that the absolute value of any component
of the vector $\lqgrad{\zeta \vert \eta}\psi(\zeta \vert \eta)$ is
bounded above by $\norm{\lqgrad{\zeta \vert \eta}\psi(\zeta \vert \eta)}_2$,
together with the fact that, for any fuction $a(\zeta)$,
%
\begin{align*}
%
\int a(\zeta) \lambda(d\zeta) \le M(\zeta)
%
\end{align*}
%


%
\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{logq_continuous}
%
Under \assuref{q_regular}, the following are continuous functions of
$\eta$ in $\ball_\eta$:
%
\begin{align*}
%
\eta \mapsto{}& \expect{\q(\zeta \vert \eta)}{\psi(\zeta)} \mathand
%
\eta \mapsto{}&
    \fracat{\partial \expect{\q(\zeta \vert \eta)}
              {\psi(\zeta)}}{\partial \eta}{\eta} \mathand
\eta \mapsto{}&
    \fracat{\partial^2 \expect{\q(\zeta \vert \eta)}
                  {\psi(\zeta)}}{\partial \eta \partial \eta^2}{\eta}.
%
\end{align*}
%
\begin{proof}
%
By \assuref{q_regular}, $\q(\zeta \vert \eta) \psi(\zeta) < M(\zeta)$, so we can
apply continuity of $\eta \mapsto \q(\zeta \vert \eta)$ and the Lebesgue dominated
convergence theorem (CITE DUDLEY) to get
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta}
\abs{ \expect{\q(\zeta \vert \eta)}{\psi(\zeta)} -
      \expect{\q(\zeta \vert \eta')}{\psi(\zeta)}} \le{}&
\lim_{\eta' \rightarrow \eta}
\int \abs{\psi(\zeta)}
        \abs{\q(\zeta \vert \eta) -
             \q(\zeta \vert \eta')}\lambda(d\zeta) \\={}&
\int \abs{\psi(\zeta)}
    \lim_{\eta' \rightarrow \eta}
     \abs{\q(\zeta \vert \eta) -
          \q(\zeta \vert \eta')}\lambda(d\zeta) \\={}& 0.
%
\end{align*}
%
Applying analogous reasoning to \eqref{q_sens_is_cov, q_score_sens_is_cov}
gives the remainig results.
%
\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
