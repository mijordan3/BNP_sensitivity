
We will make frequent use of a corrolary of the dominated convergence
theorem, so we state it here.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{thm}\thmlabel{dct}
\citep[Theorem 16.8]{billingsley:1986:probability}
%
Let $\lambda$ be a probability measure on $\thetadom$, and let $S_\t \subseteq
\mathbb{R}$.  Let $f:\thetadom \times S_\t \mapsto \mathbb{R}$.

If there exists a function $M(\theta)$ with $\int M(\theta) \lambda(d\theta) <
\infty$ such that $\abs{f(\theta, \t)} \le M(\theta)$, $\lambda$-almost surely,
for all $\t \in S_\t$, then the map $\t \mapsto \int f(\theta, \t)
\lambda(d\theta)$ is continuous.

Further, suppose that the derivative $\fracat{\partial f(\theta, \t)}{\partial
\t}{\t}$ exist $\lambda$-almost surely for $\t \in S_\t$.  If there exists
an $M'(\theta)$ such that $\int M'(\theta) \lambda(d\theta) < \infty$ and
$\abs{\fracat{\partial f(\theta, \t)}{\partial \t}{\t}} \le M'(\theta)$,
$\lambda$-almost surely and for all $\t \in S_\t$, then
%
\begin{align*}
%
\fracat{\partial \int f(\theta, \t) \lambda(d\theta)}{\partial \t}{\t} =
     \int \fracat{\partial f(\theta, \t)}{\partial \t}{\t} \lambda(d\theta).
%
\end{align*}
%
\end{thm}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{logq_derivs}
%
Let \assuref{dist_fun_nice} hold for some $\psi(\theta, \t)$ as well as
for $\psi(\theta, \t) = 1$.  Define
%
\begin{align*}
%
\lqgradbar{\theta \vert \eta} :={}& \lqgrad{\theta \vert \eta}
  - \expect{\q(\theta \vert \eta)}{\lqgrad{\theta \vert \eta}} \\
\lqhessbar{\theta \vert \eta} :={}& \lqhess{\theta \vert \eta}
 - \expect{\q(\theta \vert \eta)}{\lqhess{\theta \vert \eta}}.
%
\end{align*}
%
Then the following equalties hold:
%
\begin{align}
%
\MoveEqLeft
\fracat{\partial \expect{\q(\theta \vert \eta)}
              {\psi(\theta, \t)}}{\partial \eta}{\eta} ={}
\expect{\q(\theta \vert \eta)}
       {\lqgradbar{\theta \vert \eta} \left(
        \psi(\theta,\t) - \expect{\q(\theta \vert \eta)}{\psi(\theta, \t)}
       \right)
       }\eqlabel{q_sens_is_cov}\\\nonumber\\
%
\MoveEqLeft
\fracat{\partial^2 \expect{\q(\theta \vert \eta)}
      {\psi(\theta, \t)}}{\partial \eta \partial \t}{\eta, \t} ={}\nonumber\\&
  \expect{\q(\theta \vert \eta)}
         {\lqgradbar{\theta \vert \eta} \left(
          \psigrad{\theta,\t} - \expect{\q(\theta \vert \eta)}{\psigrad{\theta, \t})}
         \right)
         } \eqlabel{q_sens_psi_grad_is_cov} \\\nonumber\\
 %
 \MoveEqLeft
 \fracat{\partial^2 \expect{\q(\theta \vert \eta)}
       {\psi(\theta, \t)}}{\partial \eta \partial \eta^T}{\eta} ={}
 \nonumber\\&
 \expect{\q(\theta \vert \eta)}
        {\lqgradbar{\theta \vert \eta} \lqgradbar{\theta \vert \eta}^T
        \left(
         \psi(\theta,\t) - \expect{\q(\theta \vert \eta)}{\psi(\theta, \t)}
        \right)
        } +
 \nonumber\\ &
 \expect{\q(\theta \vert \eta)}{
        \lqhessbar{\theta \vert \eta}
        \left(
         \psi(\theta,\t) - \expect{\q(\theta \vert \eta)}{\psi(\theta, \t)}
        \right)
        }. \eqlabel{q_score_sens_is_cov}
%
\end{align}
%
\begin{proof}
%
The proof follows by repeatedly using \thmref{dct} to interchange the order of
integration and differentiation as in \citep[Theorem
1]{giordano:2018:covariances}.  For example,
%
\begin{align*}
%
\MoveEqLeft
\fracat{\partial \int \q(\theta \vert \nu) \psi(\theta \vert \t) \lambda(d\theta)}
       {\partial \eta}{\eta}
={}\\&
\int \fracat{\partial \q(\theta \vert \nu) \psi(\theta \vert \t) }
          {\partial \eta}{\eta} \lambda(d\theta)={}
&\mathtxt{(\assuitemref{dist_fun_nice}{fundom} and \thmref{dct})}
\\&
\int \lqgrad{\theta, \eta} \psi(\theta \vert \t) \q(\theta, \eta) \lambda(d\theta) ={}
\\&
\expect{\q(\theta, \eta)}{\lqgrad{\theta, \eta} \psi(\theta \vert \t) }.
%
\end{align*}
%
Applying analogous reasoning to the denominator of
%
\begin{align*}
%
\expect{\q(\theta \vert \eta)}{\psi(\theta, \t)} =
\frac{\int \psi(\theta, \t) \q(\theta \vert \eta) \lambda(d\theta)}
     {\int \q(\theta \vert \eta) \lambda(d\theta)}
%
\end{align*}
%
and applying the chain rule gives \eqref{q_sens_is_cov}.

For \eqref{q_sens_psi_grad_is_cov}, by anaologously applying
\assuitemref{dist_fun_nice}{fundom} and the DCT gives
%
\begin{align*}
%
\fracat{\partial \expect{\q(\theta \vert \eta)}{\psi(\theta \vert \eta)}}
       {\partial \t}{\t} ={}&
\expect{\q(\theta \vert \eta)}{\psigrad{\theta \vert \eta}}.
%
\end{align*}
%
Applying \assuitemref{dist_fun_nice}{funqgraddom} and \thmref{dct} gives
%
\begin{align*}
%
\fracat{\partial \expect{\q(\theta \vert \eta)}
                        {\lqgrad{\theta \vert \eta}\psi(\theta \vert \eta)}}
       {\partial \t}{\t} ={}&
\expect{\q(\theta \vert \eta)}
       {\lqgrad{\theta \vert \eta} \psigrad{\theta \vert \eta}},
%
\end{align*}
%
where we have used the fact that the absolute value of any component of the
vector $\lqgrad{\theta \vert \eta}\psi(\theta \vert \eta)$ is bounded above by a
constant times $\norm{\lqgrad{\theta \vert \eta}\psi(\theta \vert \eta)}_2$.
From the preceding two displays, \eqref{q_sens_psi_grad_is_cov} follows.

Finally, for \eqref{q_score_sens_is_cov}, we need to differentiate
\eqref{q_sens_is_cov}.  In addition to quantities already considered
above, \eqref{q_sens_is_cov} involves terms of the following form,
to which we can apply \thmref{dct} using the corresponding assumptions:
%
\begin{align*}
%
\expect{\q{\theta \vert \eta}}
    {\lqgrad{\theta \vert \eta}} &&
    \textrm{\assuitemref{dist_fun_nice}{funqgraddom}}\\
\expect{\q{\theta \vert \eta}}
    {\lqgrad{\theta \vert \eta} \psi(\theta, \t)}. &&
    \textrm{\assuitemref{dist_fun_nice}{funqgraddom}}
%
\end{align*}
%
\Eqref{q_score_sens_is_cov} then follows by differentiating as above and
collecting terms.
%
\end{proof}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lem}\lemlabel{logq_continuous}\seeproof{logq_continuous}
%
Let \assuref{dist_fun_nice} hold for some $\psi$ as well as with $\psi(\theta,
\t) = 1$.  Then
%
\begin{align*}
%
\eta, \t \mapsto{}& \fracat{\partial
\expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta}{\eta, \t}
%
\mathtxt{,}\\
%
\eta, \t \mapsto{}& \fracat{\partial^2
\expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta \partial
\t}{\eta, \t}
%
\mathtxt{, and}\\
%
\eta, \t \mapsto{}&  \fracat{\partial^2
\expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta \partial
\eta^T}{\eta}
%
\end{align*}
%
are continuous on $\ball_\eta \times \ball_\t$.
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%
\begin{proof}[Proof of \lemref{logq_continuous}]\prooflabel{logq_continuous}
%
By \lemref{logq_derivs}, the mixed partial $ \eta, \t \mapsto \fracat{\partial^2
\expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta \partial
\t}{\eta, \t}$ is a continuous combination of terms of the form
%
\begin{align*}
%
\expect{\q(\theta \vert \eta)}
       {\lqgrad{\theta \vert \eta} \psigrad{\theta,\t}}
       && \mathtxt{\assuitemref{dist_fun_nice}{fungradqgraddom}} \\
\expect{\q(\theta \vert \eta)}
      {\lqgrad{\theta \vert \eta}}
      && \mathtxt{\assuitemref{dist_fun_nice}{funqgraddom}} \\
\expect{\q(\theta \vert \eta)}
    {\psigrad{\theta,\t}}.
    && \mathtxt{\assuitemref{dist_fun_nice}{funqgraddom}}
%
\end{align*}
%
By the corresponding assumptions, \thmref{dct} applies to each of these terms,
and by \assuref{dist_fun_nice}, each of the expressions in the preceding display
are continuous.  For example,
%
\begin{align*}
%
\MoveEqLeft
\norm{\expect{\q(\theta \vert \eta)}
       {\lqgrad{\theta \vert \eta} \psigrad{\theta,\t}} -
   \expect{\q(\theta \vert \eta')}
          {\lqgrad{\theta \vert \eta'} \psigrad{\theta,\t'}}
      }_2 =\\&
%
\norm{\int \left(
\q(\theta \vert \eta) \lqgrad{\theta \vert \eta} \psigrad{\theta,\t} -
\q(\theta \vert \eta') \lqgrad{\theta \vert \eta'} \psigrad{\theta,\t'}
\right)\lambda(d\theta)
}_2  \le\\&
%
\int \norm{
\q(\theta \vert \eta) \lqgrad{\theta \vert \eta} \psigrad{\theta,\t} -
\q(\theta \vert \eta') \lqgrad{\theta \vert \eta'} \psigrad{\theta,\t'}
}_2 \lambda(d\theta) \le\\&
%
\int \norm{
\left(\q(\theta \vert \eta) - \q(\theta \vert \eta')\right)
    \lqgrad{\theta \vert \eta} \psigrad{\theta, \t}
}_2 \lambda(d\theta) + \\&\quad
%
\int \norm{
\q(\theta \vert \eta')
    \left( \lqgrad{\theta \vert \eta} - \lqgrad{\theta \vert \eta'} \right)
    \psigrad{\theta, \t}
}_2 \lambda(d\theta) + \\&\quad
%
\int \norm{
\q(\theta \vert \eta')\lqgrad{\theta \vert \eta'}
    \left( \psigrad{\theta, \t} - \psigrad{\theta, \t'} \right)
}_2 \lambda(d\theta).
%
\end{align*}
%
By \assuitemref{dist_fun_nice}{fungradqgraddom} we can apply \thmref{dct} to
each term in the final line of the preceding display, giving
%
\begin{align*}
%
\MoveEqLeft
\lim_{\eta' \rightarrow \eta} \lim_{\t' \rightarrow \t}
\norm{\expect{\q(\theta \vert \eta)}
       {\lqgrad{\theta \vert \eta} \psigrad{\theta,\t}} -
   \expect{\q(\theta \vert \eta')}
          {\lqgrad{\theta \vert \eta'} \psigrad{\theta,\t'}}
      }_2 \le\\&
%
\int \lim_{\eta' \rightarrow \eta} \lim_{\t' \rightarrow \t} \norm{
\left(\q(\theta \vert \eta) - \q(\theta \vert \eta')\right)
    \lqgrad{\theta \vert \eta} \psigrad{\theta, \t}
}_2 \lambda(d\theta) + \\&\quad
%
\int \lim_{\eta' \rightarrow \eta} \lim_{\t' \rightarrow \t} \norm{
\q(\theta \vert \eta')
    \left( \lqgrad{\theta \vert \eta} - \lqgrad{\theta \vert \eta'} \right)
    \psigrad{\theta, \t}
}_2 \lambda(d\theta) + \\&\quad
%
\int \lim_{\eta' \rightarrow \eta} \lim_{\t' \rightarrow \t} \norm{
\q(\theta \vert \eta')\lqgrad{\theta \vert \eta'}
    \left( \psigrad{\theta, \t} - \psigrad{\theta, \t'} \right)
}_2 \lambda(d\theta) = 0,
%
\end{align*}
%
the final equality following from the continuity assumptions of
\assuref{dist_fun_nice}.

Similarly, $\fracat{\partial^2
\expect{\q(\theta \vert \eta)} {\psi(\theta, \t)}}{\partial \eta \partial
\eta^T}{\eta}$ involves terms of the form
%
\begin{align*}
%
\expect{\q(\theta \vert \eta)}
       {\lqgrad{\theta \vert \eta} \lqgrad{\theta \vert \eta}^T
        \psi(\theta,\t)}
       && \mathtxt{\assuitemref{dist_fun_nice}{funqgradsqdom}} \\
       %
\expect{\q(\theta \vert \eta)}
      {\lqgrad{\theta \vert \eta} \lqgrad{\theta \vert \eta}^T}
      && \mathtxt{\assuitemref{dist_fun_nice}{funqgradsqdom}} \\
%
\expect{\q(\theta \vert \eta)}
       {\lqhess{\theta \vert \eta}
        \psi(\theta,\t)}
       && \mathtxt{\assuitemref{dist_fun_nice}{funqhessdom}} \\
%
\expect{\q(\theta \vert \eta)}
       {\lqhess{\theta \vert \eta}},
       && \mathtxt{\assuitemref{dist_fun_nice}{funqhessdom}}
%
\end{align*}
%
to which we can apply \thmref{dct} by the corresponding assumption.  Reasoning
analogously to the other term, the conclusion follows.
%
\end{proof}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


Next, we prove a result for directional derivatives in $\lp{p}$ spaces.


\begin{assu}\assulabel{lp_regular}
%
Fix $p$, $\pbase$, and $\lambda$ as in \defref{prior_nl_pert}, and let
$\q(\theta)$ be a density defined relative to $\lambda$.  Let $q$ be such that
$p^{-1} + q^{-1} = 1$.  Fix a function $\psi(\theta): \thetadom \mapsto
\mathbb{R}$ with $\expect{\q(\theta)}{\abs{\psi(\theta)}} < \infty$, and assume that
%
\begin{align*}
%
\int \abs{\frac{\psi(\theta) \q(\theta)}{\pbase(\theta)}}^q
\pbase(\theta) \lambda(d\theta) < \infty.
%
\end{align*}
%
or, equivalently, that
%
\begin{align*}
%
\int \abs{\frac{\psi(\theta) \q(\theta)}{\pbase(\theta)}}^{q-1}
    \q(\theta) \lambda(d\theta)
< \infty.
%
\end{align*}
%
\end{assu}


\begin{lem}\lemlabel{lp_integral_bound}
%
Under \assuref{lp_regular}, if $\norm{\gamma}_{\pbase, p} < \infty$, then there
exists an $M(\theta)$ with $\int M(\theta) \lambda(d\theta) < \infty$
such that, for all $0 \le \t \le (2 \abs{\inf_\theta \gamma(\theta)})^{-1}$,
%
\begin{align}\eqlabel{lp_integral_bound}
%
\abs{\psi(\theta)}\abs{\logtrim\left(1 + \t \gamma(\theta)\right)}\q(\theta)
    <{}& M(\theta).
\end{align}
%
If $\inf_\theta \psi(\theta) > \infty$, then we can define $M(\theta)$ so that,
additionally,
%
\begin{align}\eqlabel{lp_integral_deriv_bound}
%
\abs{\psi(\theta)}\abs{\t \gamma(\theta)} \q(\theta)
    <{}& M(\theta).
%
\end{align}
%
\begin{proof}

First, suppose that $\inf_\theta \psi(\theta) = -\infty$.  Then
$\logtrim\left(1 + \t \gamma(\theta)\right) = 0$ for all $\t \ge 0$, and
\eqref{lp_integral_bound} holds trivially with $M(\theta) = 0$.

Next, suppose that $\inf_\theta \psi(\theta) > -\infty$, and let
$\t_{max} := (2 \abs{\inf_\theta \gamma(\theta)})^{-1}$.  Then, if
$\t \le \t_{max}$, then
$\inf_\theta \logtrim \left(1 + \t \gamma(\theta)\right) \ge \log(1/2)$.
Let us limit to such $\t$.  We can write
%
\begin{align*}
%
\MoveEqLeft
\int \abs{\psi(\theta)}
    \abs{\logtrim\left(1 + \t \gamma(\theta)\right)}\q(\theta)
    \lambda(d\theta) ={}
\\&
\int \abs{\psi(\theta)}
    \abs{\logtrim\left(1 + \t \gamma(\theta)\right)}
    \ind{\gamma(\theta) \le 0}
    \q(\theta)\lambda(d\theta)  +
\\&
\int \abs{\psi(\theta)}
    \abs{\logtrim\left(1 + \t \gamma(\theta)\right)}
    \ind{\gamma(\theta) > 0}
    \q(\theta)\lambda(d\theta).
%
\end{align*}
%
For all $0 \le \t \le \t_{max}$, $0 \le \abs{\logtrim\left(1 + \t
\gamma(\theta)\right)} \ind{\gamma(\theta) \le 0} \le \log(1/2)$,
so the first term in the preceding display is dominated by the integrable
function $\log(1/2) \abs{\psi(\theta)}\q(\theta)$.

For the second term, by Holder's inequality with respect to $\pbase(\theta)$,
%
\begin{align*}
%
\MoveEqLeft
\int \abs{\psi(\theta)}
    \abs{\logtrim\left(1 + \t \gamma(\theta)\right)}
    \ind{\gamma(\theta) > 0}
    \q(\theta)\lambda(d\theta)
\\\le{}&
\t_{max}
\int \abs{\psi(\theta)}
    \abs{\gamma(\theta)}
    \ind{\gamma(\theta) > 0}
    \q(\theta)\lambda(d\theta)
\\={}&
\t_{max}
\int \abs{\psi(\theta)}
    \abs{\gamma(\theta)}
    \ind{\gamma(\theta) > 0}
    \frac{\q(\theta)}{\pbase(\theta)} \pbase(\theta) \lambda(d\theta)
\\\le{}&
\t_{max}
\left(
\int
    \abs{\frac{\psi(\theta)\q(\theta)}{\pbase(\theta)}}^q
    \pbase(\theta) \lambda(d\theta)
\right)^{1/q}
\left(
\int\abs{\gamma(\theta)}^p \pbase(\theta) \lambda(d\theta)
\right)^{1/p}
\\\le{}&
\t_{max}
\left(
\int
    \abs{\frac{\psi(\theta)\q(\theta)}{\pbase(\theta)}}^q
    \pbase(\theta) \lambda(d\theta)
\right)^{1/q}
\norm{\gamma}_{\pbase,p}.
%
\end{align*}
%
By assumption, the final equation in the preceding display is finite.

\Eqref{lp_integral_deriv_bound} follows by applying Holder's inequality
in the same way directly to \eqref{lp_integral_deriv_bound}.
%
\end{proof}
%
\end{lem}

%
% \begin{lem}\lemlabel{lp_derivative}
% %
% Fix $p$, $\pbase$, and $\lambda$ as in \defref{prior_nl_pert}, and let
% $\q(\theta \vert \eta)$ define a class of densities relative to $\lambda$
% parameterized by $\eta$ in an open ball $\ball_\eta$.  Let \assuref{lp_regular}
% hold uniformly in $\ball_\eta$ (i.e., the supremum over $\eta \in \ball_\eta$
% of the integrals in \assuref{lp_regular} is finite) for the ....
%
% No, let's split it up.
% %
% \end{lem}
