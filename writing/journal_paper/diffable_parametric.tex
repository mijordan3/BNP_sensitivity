We now state conditions under which $\t \mapsto \etaopt(\t)$, as defined by
\defref{prior_t}, is continuously differentiable.  Our key theoretical tool will
be the implicit function theorem (e.g., \citet{krantz:2012:implicit}), applied
to the first-order conditions for the VB optimization problem, and the dominated
converence theorem (e.g., \citet[Theorem 16.8]{billingsley:1986:probability}),
which will allow us to express derivatives of variational expectations in terms
of properties  of other variational expectations.

The derivative can expressed in terms of unnormalized densities, which can
simplify some computation.  To that end, let $\qtil$ and $\ptil$ refer to
potentially unnormalized (but normalizable) versions of the respectively
corresponding $\q$ and $\p$ given in \defref{prior_t}, so that
%
\begin{align*}
%
\q(\theta \vert \eta) :={}
    \frac{\qtil(\theta \vert \eta)}
    {\int \qtil(\theta' \vert \eta) \mu(d\theta')} \mathand
\p(\theta \vert \t) :={}
    \frac{\ptil(\theta \vert \t)}
    {\int \ptil(\theta' \vert \t) \mu(d\theta')}.
%
\end{align*}

For \assuref{kl_opt_ok}, we state some regularity conditions on the ``base
problem'', $\KL{\eta}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{assu}\assulabel{kl_opt_ok}
%
Let the following conditions on the variational approximation hold.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{enumerate}
%
    \item \itemlabel{kl_diffable} The map $\eta \mapsto \KL{\eta}$ is twice
    continuously differentiable at $\etaopt$.

    \item\itemlabel{kl_hess} The Hessian matrix $\fracat{\partial^2 \KL{\eta}}
    {\partial \eta \partial \eta^T} {\etaopt}$ is non-singular.

    \item \itemlabel{kl_opt_interior} There exists an open ball $\ball_\eta
    \subset \mathbb{R}^\etadim$ such that $\etaopt \in \ball_\eta \subset
    \etadom$.
%
\end{enumerate}
%
\end{assu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Next, we assume that we can exchange the order of integration and
differentiation in variational expectations.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\begin{assu}\assulabel{exchange_order}
%
Assume that the map $\eta \mapsto \qtil(\theta \vert \eta)$ is twice
continuously differentiable, and that the map $\t \mapsto \ptil(\theta \vert
\t)$ is continuously differentiable.

% Which version is better?
% Assume that we can exchange the order of $\q$-integration and differentiation in
% the expression $\expect{\q(\theta \vert \eta)}{\log \ptil(\theta \vert \t)}$ at
% $\eta = \etaopt$ and $\t = 0$ for the derivatives $\partial / \partial \eta$,
% $\partial^2 / \partial \eta^2$, and $\partial^2 / \partial \eta \partial \t$.

Furhter, assume that we can exchange the order of integration and
differentiation in the expressions $\int \qtil(\theta \vert \eta) \log
\ptil(\theta \vert \t) \mu(d\theta)$ and $\int \qtil(\theta \vert \eta)
\mu(d\theta)$ at $\eta = \etaopt$ and $\t = 0$ for the derivatives $\partial /
\partial \eta$, $\partial^2 / \partial \eta^2$, and $\partial^2 / \partial \eta
\partial \t$.
%
\end{assu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In certain cases, one can verify \assuref{exchange_order} directly, such as when
$\expect{\q(\theta \vert \eta)}{\log \ptil(\theta \vert \t)}$ has a closed form.
For more general situations, the following straightforward extention of the
dominated convergence theorem \citep[Theorem 16.8]{billingsley:1986:probability}
is useful.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\todo{Make this into a separate assumption and lemma.}
\begin{lem}\lemlabel{exchange_order}
%
Let $M(\theta) > 0$ be a measurable function with $\int M(\theta) \mu(d\theta) <
\infty$.  Let $f(\theta, \eta, \t)$ denote a function that is continuously
differentiable in $\t$ and measurable in $\theta$ for $\eta, \t \in \ball_\eta
\times \ball_\t$, where $\ball_\eta \times \ball_\t$ is open.

\todo{Include differentiability assumptions here}

Assume that, for all $\eta, \t \in \ball_\eta \times \ball_\t$, $M(\theta)$ is
$\mu$-almost everywhere greater than each of the following functions: $f(\theta,
\eta, \t)$, $\norm{\partial f(\theta, \eta, \t) / \partial \eta}_2$,
$\norm{\partial^2 f(\theta, \eta, \t) / \partial \eta \partial \eta^T}_2$, and
$\norm{\partial^2 f(\theta, \eta, \t) / \partial \eta \partial \t}_2$. Then, at
any $\eta, \t \in \ball_\eta \times \ball_\t$, we can exchange the order of
integration and differentiation in $\int f(\theta, \eta, \t) \mu(d\theta)$ for
the derivatives $\partial / \partial \eta$, $\partial^2 / \partial \eta^2$, and
$\partial^2 / \partial \eta \partial \t$.

\seeproof{exchange_order}
%
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\begin{assu}\assulabel{exchange_order_dom}
(Sufficient conditions for \assuref{exchange_order}.)
%
Assume that \lemref{exchange_order} applies with the function $f(\theta, \eta,
\t) = \qtil(\theta \vert \eta) \log \ptil(\theta \vert \t)$ as well as with
$f(\theta, \eta, \t) = \qtil(\theta \vert \eta)$.
%
\end{assu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The advantage of \assuref{exchange_order_dom} over \assuref{exchange_order} is
that the conditions of \assuref{exchange_order_dom} can typically be verified
even when the expectation $\expect{\q(\theta \vert \eta)}{\log \ptil(\theta
\vert \t)}$ does not have a closed form.  In \secref{diffable_concentration}, we
will dicuss how different choices of variational approximations for the stick
lengths lend themselves to either \assuref{exchange_order} of
\assuref{exchange_order_dom}.

We are now in a position to define the quantities that occur in the derivative.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{defn}\deflabel{deriv_quantities}
%
Under the conditions of \defref{prior_t}, when \assuref{kl_opt_ok,
exchange_order} hold, define
%
\begin{align*}
%
\hessopt :={}& \fracat{\partial^2 \KL{\eta}}
                      {\partial \eta \partial \eta^T}
                      {\etaopt} \mathand \\
%
\lqgradbar{\theta \vert \etaopt} :={}&
    \lqgrad{\theta \vert \etaopt} -
    \expect{\q(\theta \vert \etaopt)}{\lqgrad{\theta \vert \etaopt}}.
%
\end{align*}

% Note that if $\qtil(\theta \vert \eta)$ is already normalized ($\qtil = \q$),
% then $\expect{\q(\theta \vert \eta)}{\lqgrad{\theta \vert \eta}} = 0$ for all
% $\eta$ and $\lqgradbar{\theta \vert \etaopt} = \lqgrad{\theta \vert \etaopt}$.

Further, define

\begin{align*}
%
\crosshessian :={}&
    \fracat{\partial
            \expect{\q(\theta \vert \etaopt)}
                   {\fracat{\partial \log \ptil(\theta \vert \t)}
                           {\partial \t}{\t=0} }
            }
        {\partial \eta}{\etaopt}
={}
    \expect{\q(\theta \vert \etaopt)}{
          \lqgradbar{\theta \vert \etaopt}
          \fracat{\partial \log \ptil(\theta \vert \t)}
                 {\partial \t}{\t=0}},
%
\end{align*}
%
where the final equality follows from differentiating under the integral using
\assuref{exchange_order} (see \lemref{logq_continuous} in \appref{proofs} for
more details).
%
\end{defn}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{thm}\thmlabel{etat_deriv}
%
Under the conditions of \defref{prior_t, deriv_quantities}, let
\assuref{kl_opt_ok, exchange_order} hold.   Then the map $\t \mapsto
\etaopt(\t)$ is continuously differentiable at $\t=0$ with derivative
%
\begin{align}\eqlabel{vb_eta_sens}
%
\fracat{d \etaopt(\t)}{d \t}{0} ={}&
    - \hessopt^{-1} \crosshessian.
%
\end{align}
%
(For a proof, see \appref{proofs} \proofref{etat_deriv}.)
%
\end{thm}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
