In this section, we return to the BNP problem and prove carefully that the map
$\alpha \mapsto \etaopt(\alpha)$ satisfies \assuref{kl_opt_ok, exchange_order},
and so the conditions of \thmref{etat_deriv}.  As in \exref{alpha_perturbation},
we will take $\mu$ to be the Lebesgue measure on $[0,1]^{\kmax - 1}$.

Recall from \secref{model_vb} that we take $\q(\nuk \vert \eta)$ to be a normal
distribution on the logit-transformed sticks, $\lnu_\k$.  For the duration of
this section, write $\q(\lnuk \vert \eta) = \normdist{\lnuk \vert \mu_\k,
\sigma^2_\k}$, so that the subvector of $\eta$ parameterizing $\q(\lnuk \vert
\eta)$ is $\etanuk = (\mu_\k, \sigma_\k)$.
%
By the formula for transformation of probability densities,
%
\begin{align*}
%
\q(\nuk \vert \etanuk) =
    \normdist{\log\left(\frac{\nu_\k}{1 - \nu_\k} \right)
        \Big\vert  \mu_\k, \sigma^2_\k}
    \frac{1}{\nuk (1 - \nuk)},
%
\end{align*}
%
where we have used the fact that $\fracat{d \lnu_\k}{ d\nuk}{\nuk} =
\frac{1}{\nuk (1 - \nuk)}$.  Similarly, for any function $f(\nuk)$ of the stick
lengths, we can transform the expecations as $\expect{\q(\nuk \vert
\etanuk)}{f(\nuk)} = \expect{\q(\lnuk \vert \etanuk)}{f\left(
\frac{\exp(\lnuk)}{1 + \exp(\lnuk)}  \right))}$, using the fact that
$\nuk = \frac{\exp(\lnuk)}{1 + \exp(\lnuk)}$.

Differentiability of $\KL{\eta}$ (\assuitemref{kl_opt_ok}{kl_diffable}) is
immediately satisfied for the $\eta$ that parameterize $\q(\beta \vert \eta)$
and $\q(\z \vert \eta)$ by our use of conjugate approximating families and
standard parameterizations.  The stick length density, $\q(\nuk \vert \etanuk)$
is not a standard exponential family
%
\footnote{In this section, we continue to take $\mu$ to be the Lebesgue measure
on $[0,1]$ as in \exref{alpha_perturbation}.  We could have equivalently taken
$\mu$ to be the Lebesgue measure on $\mathbb{R}$ and analyzed $\p(\lnuk \vert
\alpha)$ instead.  Had we done so, the same log Jacobian term $\log (\nuk(1 -
\nuk))$ would have appeared in the $\log \ptil(\lnuk \vert \alpha)$ term rather
than the $\q(\lnuk \vert \etanuk)$ entropy term, and so been part of
\assuref{exchange_order} rather than \assuitemref{kl_opt_ok}{kl_diffable}.  For
essentially this reason, the choice of dominainting measure in \defref{prior_t}
does not matter.}
%
, so we must show that the entropy $\expect{\q(\nuk \vert \etanuk)}{\log \q(\nuk
\vert \etanuk)}$ is  twice continuously differentiable. The entropy is given up
to a constant by
%
\begin{align*}
%
\MoveEqLeft
\expect{\q(\nuk \vert \etanuk)}{\log \q(\nuk \vert \etanuk)}
\\={}&
    \expect{\q(\nuk \vert \etanuk)}
           {\log \normdist{\log\left(\frac{\nu_\k}{1 - \nu_\k} \right)
               \Big\vert  \mu_\k, \sigma^2_\k}} +
    \expect{\q(\nuk \vert \etanuk)}
           {\log \left(\nuk (1 - \nuk)\right)}
% \\={}&
%     \expect{\q(\lnuk \vert \etanuk)}
%            {\log \normdist{\lnuk \Big\vert  \mu_\k, \sigma^2_\k}} +
%     \expect{\q(\lnuk \vert \etanuk)}
%            {\log \frac{\exp(\lnuk)}{1 + \exp(\lnuk)} } -
%     \expect{\q(\lnuk \vert \etanuk)}
%            {\log \frac{1}{1 + \exp(\lnuk)} }
\\={}&
   \expect{\q(\lnuk \vert \etanuk)}
          {\log \normdist{\lnuk \Big\vert  \mu_\k, \sigma^2_\k}} +
   \expect{\q(\lnuk \vert \etanuk)}{\lnuk}
\\={}&
    \frac{1}{2} \log \sigma^2_\k + \mu_\k + \const,
%
\end{align*}
%
which is twice continuously differentiable by inspection.
%
Indeed, \assuitemref{kl_opt_ok}{kl_diffable} is typically satisfied in VB
problems; when it is not, many black-box optimization methods also do not apply.

Non-singularity of the Hessian matrix $\hessopt$
(\assuitemref{kl_opt_ok}{kl_hess}) is satisfied whenever $\etaopt$ is at a local
optimum of $\KL{\eta}$.  In practice, we compute $\etaopt$ and (approximately)
check \assuitemref{kl_opt_ok}{kl_hess} numerically as part of computing the
sensitivity $\hessopt^{-1} \crosshessian$.  As with
\assuitemref{kl_opt_ok}{kl_diffable}, if \assuitemref{kl_opt_ok}{kl_hess} is
violated, then the user will probably have difficulty optimizing $\KL{\eta}$.

\assuitemref{kl_opt_ok}{kl_opt_interior} essentially requires that $\KL{\eta}$
be well-defined in an $\mathbb{R}^\etadim$ neighborhood of $\etaopt$, and can
require some care in choosing the parameterization $\eta$.  As an example of a
parameterization that would violate \assuitemref{kl_opt_ok}{kl_opt_interior},
consider parametrizing $\q(\z_{\n} \vert \eta)$ by the $\kmax$ expectations
$m_\k := \expect{\q(\z_{\n} \vert \eta)}{\z_{\n\k}}$.  The set $(m_1, \ldots,
m_\kmax)$ completely specify $\q(\z_{\n} \vert \eta)$, but violate
\assuitemref{kl_opt_ok}{kl_opt_interior}, since any valid parametization
satisfies $\sum_{\k=1}^\kmax m_\k = 1$, and so no open ball in
$\mathbb{R}^\etadim$ can be contained in $\etadom$.  However,
\assuitemref{kl_opt_ok}{kl_opt_interior} is satisfied we use an {\em
unconstrained parameterization} for $\q(\zeta \vert \eta)$.   Unconstrained
parameterizations of variational distributions allow the use of unconstrained
optimization for variational inference and are a good practice when available
\citep{kucukelbir:2016:advi}.  For details on our parameterizations, see
\appref{app_vb_details}.

Verifying \assuref{exchange_order} is the principal technical challenge of
satisfying the conditions of \thmref{etat_deriv}. Recall from
\exref{alpha_perturbation} that $\log \ptil(\nuk \vert \t) = t \log (1 - \nuk)$,
so we need to establish \assuref{exchange_order} for
%
\begin{align*}
%
-\expect{\q(\nuk \vert \etanuk)}{t \log (1 - \nuk)} =
% -\expect{\q(\lnuk \vert \etanuk)}
%        {t \log (1 - \frac{\exp(\lnuk)}{1 + \exp(\lnuk)})} =
\expect{\q(\lnuk \vert \etanuk)}
      {t \log (1 + \exp(\lnuk))}.
%
\end{align*}
%
Since the preceding equality holds for all $\t$ and $\etanuk$, it suffices to
establish that we can exchange the order of integration and differentiation for
the right hand side.  Note that derivatives with respect to any components of
$\eta$ other than $\etanuk$ are zero and so \assuref{exchange_order} is
trivially satisfied.

The following lemma establishes a general condition for the ability
to exchange normal expectations and the needed derivatives.

% \begin{align}\eqlabel{lnuk_derivatives}
% %
% \fracat{d \lnu_\k}{ d\nuk}{\nuk} ={}
% %     \frac{1-\nuk}{\nuk}
% %     \left(\frac{1}{1 - \nuk} + \frac{\nuk}{(1 - \nuk)^2} \right)
% % \\={}& \frac{1}{\nuk} + \frac{1}{1 - \nuk}
% % \\={}&
%     \frac{1}{\nuk (1 - \nuk)} \mathand
% %
% \fracat{d \nuk}{ d\lnuk}{\lnuk} ={}
%     \frac{\exp(\lnuk)}{(1 + \exp(\lnuk))^2}.
% %
% \end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lem}\lemlabel{normal_q_is_regular}
%
Let $\mu$ denote the Lebesgue measure on $\mathbb{R}$. Let $\eta = (\mu,
\sigma)$, let $\normdist{\theta \vert \eta}$ denote the corresponding normal
density with respect to $\mu$, and and let $\ball_\eta$ denote an open ball in
$\mathbb{R}^2$ such that $0 < \sigma < \infty$ for all $\eta \in \ball_\eta$.
%
Let $\ball_\t$ denote an open ball in $\mathbb{R}$, and let $\psi(\theta, \t)$
be a function such that $\theta \mapsto \psi(\theta, \t)$ is $\mu$-measurable
for all $\t \in \ball_\t$.

If there exists a constant $C > 0$ such that
%
\begin{align*}
%
\sup_{\t \in \ball_\t} \abs{\psi(\theta, \t)}
    \le C \exp(\abs{\theta})
\mathand
\sup_{\t \in \ball_\t}
    \abs{\frac{\partial \psi(\theta, \t)}{\partial \t}}
    \le C \exp(\abs{\theta}),
%
\end{align*}
%
then one can exchange the order of expectation and differentation in the
expression $\expect{\normdist{\theta \vert \eta}}{\psi(\theta, \t)}$ for the
derivatives $\partial / \partial \eta$, $\partial^2 / \partial \eta \partial
\eta$, and $\partial^2 / \partial \eta  \partial \t$, eavluated at any $\t \in
\ball_\t$ and $\eta \in \ball_\eta$.

\seeproof{normal_q_is_regular}
\end{lem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Since $\log (1 + \exp(\lnuk)) \exp(-\abs{\lnuk})  < \infty$ for all $\lnuk \in
\mathbb{R}$, the conditions of \lemref{normal_q_is_regular} are satisfied for
any ball $\ball_\eta$ such that the variational variances are all finite, and
\assuref{exchange_order} is satsified.

It follows that \thmref{etat_deriv} applies to the map $\alpha \mapsto
\etaopt(\alpha)$.
