Recall from \exref{alpha_perturbation} and \corref{our_approximation} derive
sensitivity measures for perturbations that lie within the
$\mathrm{GEM}(\alpha)$ family.  However, there is typically no {\em a priori}
reason to believe that the stick breaking prior lies within this parametric
family.  In this section, we consider perturbing the functional form of the
prior, ultimatlely proving an analogue of \thmref{etat_deriv} for a particular
function space.

To define functional perturbations, fix for the moment a base stick
distribution, $\pbase(\nuk)$ and an alternative stick distribution $\palt(\nuk)$.
Take $\t = \epsilon$ and define
%
\begin{align}\eqlabel{epsilon_pert}
%
\pstick(\nuk \vert \epsilon) ={}&
\frac{\pbase(\nuk)^{1 - \epsilon} \palt(\nuk)^\epsilon}
     {\int_0^1 \pbase(\nuk')^{1 - \epsilon} \palt(\nuk')^\epsilon d\nuk'}.
%
\end{align}
%
We thus have that $\epsilon$ parameterizes a multiplicative path from
$\pbase(\nuk)$ to $\palt(\nuk)$, with $\pstick(\nuk \vert \epsilon = 0) = \pbase(\nuk)$
and $\pstick(\nuk \vert \epsilon=1) = \palt(\nuk)$.  We will take
$\t_0$ to be $\epsilon = 0$, so that we are computing $\etaopt$ with the
prior $\pbase(\nuk)$ and approximating the optimum if we had used $\palt(\nuk)$.
%
Given this definition,
%
\begin{align*}
%
\log \pstick(\nuk \vert \epsilon) ={}&
    \log \palt(\nuk) + \epsilon \log \frac{\palt(\nuk)}{\pbase(\nuk)} + \const.
    & \constdesc{\nuk}
% \\
% \fracat{\partial \log \pstick(\nuk \vert \epsilon) }{\partial \epsilon}{0} ={}&
%     \log \frac{\palt(\nuk)}{\pbase(\nuk)} + \const.
%     & \constdesc{\nuk}
%
\end{align*}
%
Identifying $\t$ with $\epsilon$, we can apply \thmref{etat_deriv} to
$\pstick(\nuk \vert \epsilon)$ as long as $\log (\palt(\nuk) / \pbase(\nuk))$
satisfies \assuref{q_stick_regular}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{ex}
%
We can use \eqref{epsilon_pert} to form an equivalent representatoin of the
parametric perturbation given in \exref{alpha_perturbation}.  For fixed
$\alpha_0$ and $\alpha_1$, take
%
\begin{align*}
%
\pbase(\nuk) :={}& \betadist{\nuk \vert 1, \alpha_0}\\
\palt(\nuk) :={}& \betadist{\nuk \vert 1, \alpha_1}.
%
\end{align*}
%
Then, up to a constant not depending on $\nuk$,
%
\begin{align}\eqlabel{gem_epsilon_pert}
%
\log \pstick(\nuk \vert \epsilon) =
    (\alpha_0 - 1) \log(1 - \nuk) +
    \epsilon  (\alpha_1 - \alpha_0) \log(1 - \nuk).
%
\end{align}
%
Comparing \eqref{gem_alpha_pert} and \eqref{gem_epsilon_pert}, we see by taking
$\alpha = \epsilon \alpha_1$ that the two parameterizations of the prior are
formally equivalent.
%
\end{ex}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

There are many (an infinite number!) of $\palt(\nuk)$ to choose from, so, rather
than fixing $\palt$, it can be useful to think of $\etaopt(\epsilon)$ as {\em
functional} of $\palt$ \citep{gustafson:1996:local}.  Let us fix $\pbase(\nuk)$,
define $\phi(\nuk) := \epsilon \log \left(\palt(\nuk) / \pbase(\nuk)\right)$,
and re-write $\pstick(\nuk \vert \epsilon)$ in the following equivalent form:
%
\begin{align}
%
\pstick(\nuk \vert \phi) ={}&
\frac{\exp\left(\log \pbase(\nuk) + \phi(\nuk)\right)}
     {\int_0^1 \exp\left(\log \pbase(\nuk') + \phi(\nuk')\right) d\nuk'}
        \Rightarrow \eqlabel{phi_perturbation}\\
\log \pstick(\nuk \vert \phi) ={}&
    \log \pbase(\nuk) + \log \phi(\nuk) + \const.
    & \constdesc{\nuk} \nonumber
%
\end{align}
%
The advantage of using $\phi$ in \eqref{phi_perturbation} rather than specifying
$\palt$ directly is that $\pstick(\nuk \vert \phi)$ is well-defined for any
Lebesgue-integrable function $\phi(\nuk): (0,1)\mapsto\mathbb{R}$, and a valid
distribution for any function $\phi$ such that the numerator is positive and the
denominator is nonzero.  We can thus safely define perturbations in terms of
general functions without worrying about whether the functions are valid
distributions. We will take $\phiz$ to be the identically zero perturbation so
that $\pstick(\nuk \vert \phiz) = \pbase(\nuk)$, and take $\etaopt$ with no
argument to notate $\etaopt(\phiz)$.

By analogy with \eqref{kl_shorthand}, we can write
%
\begin{align}\eqlabel{kl_fun_shorthand}
%
\KL{\eta, \phi} := \KL{\q(\zeta \vert \eta) || p(\x \vert \theta, \phi)}
\mathand
\etaopt(\phi) := \argmin_{\zeta \in \etadom} \KL{\eta, \phi}.
%
\end{align}
%
Further, by analogy with \eqref{etalin_def}, if the map $\phi \mapsto
\etaopt(\phi)$ is sufficiently ``nice'', then we might hope to find a linear
functional $d\etaopt(\phi) / d\phi$ such that
%
\begin{align}\eqlabel{etalin_fun_def}
%
\etalin(\phi) := \etaopt + \fracat{d \etaopt(\phi)}{d \phi}{\t=0} \phi
%
\end{align}
%
and $\etaopt(\phi) \approx \etalin(\phi)$ when $\phi$ is ``small'' in some sense
(again, to be specified precisely below).  The compuationally intensive task of
finding $\etaopt(\phi)$ for infinitely many alternative prior distributions can
then be replaced by the analytically and computationally simple $\etalin(\phi)$.
In addition to approximating the effect of particular perturbations, we will see
below that the linearization will allow us to find worst-case perturbations as
well as convenient visual summaries of the effect of prior perturbation.

Our task, then is to find notions of ``nice'' and ''small'' such that
\eqref{etalin_fun_def} holds and $\etaopt(\phi) \approx \etalin(\phi)$. To that
end, we will embed $\phi$ in a complete normed vector space, that is, in a
Banach space.  We can then appeal to the Banach space version of the
implicit function theorem, in perfect analogy with \thmref{etat_deriv}.

Define the norm
%
\begin{align*}
%
\norminf{\phi} :={} \esssup_{\nuk} |\phi(\nuk)|,
%
\end{align*}
%
where $\esssup$ is defined with respect to the Lebesgue measure on $[0,1]$. As
pointed out by \citet{gustafson:1996:local}, $\norminf{\cdot}$ is attactive
because $\pstick(\nuk \vert \phi)$ is a valid distribution whenever $\phi$ lies
within a neighborhood of $\phiz$, as we state in the following
proposition.\footnote{\citet{gustafson:1996:local} also observes that the
converse of \propref{pert_well_defined} is not true---there exist valid
distributions with infinte $\norminf{\phi}$.  We will discuss this and other
issues related to \citet{gustafson:1996:local} below.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{prop}\proplabel{pert_well_defined}
%
% Linf also in \citet[Section 2.1, Example 5]{luenberger:1997:optimization}
Let $\linf$ denote the Banach space of functions on $[0,1]$ with the norm
$\norminf{\cdot}$ \citep[Theorem 5.2.1]{dudley:2018:real}.
There exists a $\norminf{\cdot}$-neighborhood of $\phiz$, denoted $\ball_\phi
\subset \linf$, such that $\pstick(\nuk \vert \phi)$ as defined in
\eqref{phi_perturbation} is a valid probability density for all $\phi \in
\ball_\phi$
%
\begin{proof}
%
The function $\pstick(\nuk \vert \phi)$ is a valid density whenever
$\pstick(\nuk \vert \phi) \ge 0$ with Lebesgue probability one, and $\int
\pstick(\nuk \vert \phi) = 1$. Since $\pbase(\nuk) \ge 0$,
%
\begin{align*}
%
\essinf_{\nuk \in [0,1]} \exp\left(\log \pbase(\nuk) + \phi(\nuk)\right)
    \ge{}&
\essinf_{\nuk \in [0,1]} \pbase(\nuk)
\essinf_{\nuk \in [0,1]} \exp\left(\phi(\nuk)\right)
\ge{}0,
%
\end{align*}
%
so $\pstick(\nuk \vert \phi) \ge 0$ with Lebesgue probability one. Similarly,
since $\int \pbase(\nuk) d\nuk = 1$,
%
\begin{align*}
%
\exp(-\norminf{\phi}) \le{}
\abs{\int_0^1 \exp\left(\log \pbase(\nuk) + \phi(\nuk)\right) d\nuk}
\le{}
\exp(\norminf{\phi}).
%
\end{align*}
%
so that $\int \pstick(\nuk \vert \phi) = 1$ whenever $\norminf{\phi} < \infty$.
%
\end{proof}
%
\end{prop}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{assu}\assulabel{q_fun_stick_regular}
%
Assume that the variational approximations $\q(\nu \vert \etanuk)$ to the
stick-breaking posteriors satisfy \assuref{dist_fun_nice} with $\eta_0 =
\etaopt$ and with $\psi(\zeta, \t) = 1$.
%
\end{assu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Note that \assuref{q_fun_stick_regular} is actually weaker than
\assuref{q_stick_regular}, the additional assumption in
\assuref{q_stick_regular} having been replaced by the assumption that
$\norminf{\phi} < \delta$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{thm}
%
Let \assuref{kl_opt_ok, q_fun_stick_regular} hold. Then the map $\phi \mapsto
\etaopt(\phi)$ is well-defined and continuously Fr{\'e}chet differentiable in a
neighborhood of $\phiz$ as a map from $\linf$ to $\mathbb{R}^\etadim$.
Furthermore, the derivative in the direction $\phi - \phiz$ is of the form
%
\begin{align*}
%
\fracat{d \etaopt(\phi)}{d\phi}{\phiz} \phi ={}&
    \int \infl(\nu) \phi(\nu) d\nu \mathtxt{where} \\
%
\infl(\nu) :={}&
-\left(\fracat{\partial^2 \KL{\eta, \phiz}}
                {\partial \eta \partial \eta^T}
                {\etaopt}\right)^{-1}
\left(
    \sumkm
    \q(\nu \vert \etaoptnuk)
    \nabla \log \q(\nu \vert \etaoptnuk)
\right).
%
\end{align*}
%

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{proof}
%
The map $\eta, \phi \mapsto \KL{\eta, \phi}$ is a map from the Banach space
$\mathbb{R}^\etadim \times \linf$ into the Banach space $\mathbb{R}$. Let us
take the L2 norm $\norm{\cdot}_2$ on $\mathbb{R}^{\etadim}$ and $\mathbb{R}$.
Let $\ball$ denote the ball $\ball_\eta \times \{ \phi: \norminf{\phi} <
\delta\}$ for some $\delta > 0$.  Let $\linop$ denote a linear operator from
$\ball$ to $\mathbb{R}^\etadim$, and define the dual norm
%
\begin{align*}
%
\norm{\linop}^* :=
    \sup_{\eta: \norm{\eta}_2 \le 1} \sup_{\phi: \norminf{\phi} \le 1}
     \norm{\linop(\eta, \phi)}_2.
%
\end{align*}

For any $\phi \in \ball_\phi$, observe that $\t \mapsto \pstick(\zeta \vert \t
\phi)$ satisfies \assuref{q_stick_regular} under \assuref{q_fun_stick_regular},
since, for any $f(\nu)$, $\lambda$-almost surely,
%
\begin{align*}
%
f(\nu) \phi(\nu) \le f(\nu) \norminf{\phi} \le \norminf{\phi} M(\nu).
%
\end{align*}
%
So, by \lemref{logq_continuous}, $\eta \mapsto \partial \KL{\eta, \phi} /
\partial \eta$ is continuous for any $\phi \in \ball_\phi$, and by a first-order
condition $\etaopt(\phi)$ satisfies
%
\begin{align*}
%
\fracat{\partial \KL{\eta, \phi}}
                {\partial \eta}
                {\etaopt(\phi)} = 0.
%
\end{align*}
%
Using this estimating equation, the key to the proof will be the implicit
function theorem for Banach spaces. To use the implicit function theorem, we
need to show that $\KLgrad{\eta, \phi}$ is continuously Fr{\'e}chet
differentiable at $\etaopt, \phiz$.

%  and that $\KLhess{\eta, \phi}$ is positive
% definite in $\ball$.  --- is the actually needed?

For the duration of the proof, define
%
\begin{align*}
%
\rho(\etanuk, \phi) :={}&
    \expect{\q(\nu \vert \etanuk)}{\phi(\etanuk)}
\mathand\\
\rho_\eta(\etanuk, \phi) :={}&
    \fracat{\partial \rho(\etanuk, \phi)}{\phi(\etanuk)}.
%
\end{align*}
%
Expanding $\logp(\zeta \vert \phi)$ in \eqref{vb_optimization} using
\eqref{phi_perturbation}, we see that
%
\begin{align}
\fracat{\partial \KL{\eta, \phi}}{\partial \eta}{\eta, \phi}
 ={}&
    \fracat{\partial \KL{\eta, \phiz}}{\partial \eta}{\eta} +
    \sumkm \rho_\eta(\etanuk, \phi). \eqlabel{kl_fun_pert}
%
\end{align}
%
By \assuref{kl_opt_ok}, $\partial \KL{\eta, \phiz} / \partial \eta$ is
continuously Fr{\'e}chet differentiable (it does not depend on $\phi$), so we
need consider only $\etanuk, \phi \mapsto \rho_\eta(\etanuk, \phi)$.  As
in the proof of \thmref{etat_deriv}, we will show continuous differentiability
by showing that the partial derivatives in the $\eta$ and $\phi$ directions
are continuous, this time in the dual norm $\norm{\cdot}^*$.

Let us first consider the partial derivative of $\rho_\eta(\etanuk, \phi)$ in
the $\eta$ direction. By \lemref{logq_derivs} \eqref{q_score_sens_is_cov},
%
\begin{align*}
%
\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} ={}&
\expect{\q(\nuk \vert \etanuk)}{
   \lqhessbar{\nuk \vert \etanuk}
       \left(
        \phi(\nuk) - \expect{\q(\nuk \vert \etanuk)}{\phi(\nuk)}
       \right)
       }.
%
\end{align*}
%
We need to show that the preceding expression is continuous in the dual norm
$\norm{\cdot}^*$.  The linear operator acts only in the $\eta$ direction, so
the dual norm is equivalent to operator norm $\normop{\cdot}$.  Since
the preceding display is linear in $\phi$,

%
\begin{align*}
%
\MoveEqLeft
%
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
      }^* \le \\
%
& \norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
        \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi'}
    }^* +
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi'} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
    }^* \le \\
%
& \normop{
    \expect{\q(\nuk \vert \etanuk)}
           {\lqhessbar{\nuk \vert \etanuk}}
    } \norminf{\phi - \phi'} + \\&\quad
\normop{
    \expect{\q(\nuk \vert \etanuk)}{\lqhessbar{\nuk \vert \etanuk}} -
    \expect{\q(\nuk \vert \etanuk')}{\lqhessbar{\nuk \vert \etanuk'}}
  } \norminf{\phi'}.
%
\end{align*}
%
Since continuity in $\norm{\cdot}_2$ implies continuity in $\normop{\cdot}$,
the preceding display and \lemref{logq_continuous} gives that
$\partial \rho_\eta(\etanuk, \phi) / \partial \etanuk$ is continuous,
since
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta} \lim_{\phi' \rightarrow \phi}
\norm{\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta, \phi} -
      \fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \etanuk}{\eta', \phi'}
      }^* = 0.
%
\end{align*}

Next, we consider the partial derivative in the direction $\phi$.  Observing
that $\rho_\eta(\etanuk, \phi)$ is in fact linear in $\phi$, we see that the
partial derivative in the $\phi$ direction is given by the linear map
%
\begin{align*}
%
\fracat{\partial \rho_\eta(\etanuk, \phi)}{\partial \phi}{\eta, \phi} \phi =
    \rho_\eta(\etanuk, \phi).
%
\end{align*}
%
Note that
%
\begin{align*}
%
\sup_{\phi: \norminf{\phi} \le 1} \norm{\rho_\eta(\etanuk, \phi)}_2 \le{}&
    2 \expect{\q(\nuk \vert \etanuk)}
             {\norm{\lqhessbar{\nuk \vert \etanuk}}_2
             },
%
\end{align*}
%
so that $\phi \mapsto \rho_\eta(\etanuk, \phi)$ is a bounded linear operator and so
a valid derivative.

We now need to show continuity of the map of $\eta, \phi \mapsto
\rho_\eta(\etanuk, \phi)$ in the dual norm $\norm{\cdot}^*$.  Obviously the
linear map does not depend on the location $\phi$ at which it is evaluated, so
we need consider only continuity in $\eta$.  The linear map is zero in the
$\eta$ direction, so the dual norm is given by
%
\begin{align*}
%
\MoveEqLeft
\norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}^* ={}\\&
\sup_{\phi: \norminf{\phi} \le 1}
    \norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}_2 \le{}\\&
4 \norm{
    \expect{\q(\nuk \vert \etanuk')}{\lqhessbar{\nuk \vert \etanuk'}} -
    \expect{\q(\nuk \vert \etanuk')}{\lqhessbar{\nuk \vert \etanuk}}
}_2.
%
\end{align*}
%
Applying \lemref{logq_continuous} to the preceding display gives
%
\begin{align*}
%
\lim_{\eta' \rightarrow \eta}
    \norm{\rho_\eta(\etanuk', \phi) - \rho_\eta(\etanuk, \phi)}^* = 0,
%
\end{align*}
%
and so $\partial \rho_\eta(\eta, \phi) / \partial \phi$ is a bounded linear
function, continuous in the point at which it is evaluated, and so continuously
Fr{\'e}chet differentiable.

Since its partial derivatives are continuously it follows by \citet[Proposition
4.14(c)]{zeidler:2013:functional} that the joint map $\eta, \phi \mapsto
\partial \KL{\eta, \phi} / \partial \eta$ is continuosly Fr{\'e}chet
differentiable.  Furthermore, \citet[Chapter 4 Condition
21b]{zeidler:2013:functional} holds since $\KLhess{\etaopt(\phiz), \phiz}$ is
invertible by \assuitemref{kl_opt_ok}{kl_hess}.   So we satisfy conditions (i),
(ii), and (iii) of \citet[Theorem 4.B(c)]{zeidler:2013:functional}, giving that
the function $\etaopt(\phi)$ exists.  Moreover, since $\KLgrad{\eta, \phi}$ is
continuously Fre{\'e}chet differentiable in a neighborhood of $\etaopt(\phiz),
\phiz$, by \citet[Theorem 4.B(d)]{zeidler:2013:functional}, $\etaopt(\phi)$ is
also continuously Fr{\'e}chet differentiable.


%
\end{proof}
%
\end{thm}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
