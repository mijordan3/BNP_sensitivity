There are two practical problems with forming the posterior
$\p(\beta, \nu, \z \vert \x)$ based on the joint distribution given in
\eqref{bnp_model}.  First, there are an infinite number of parameters,
and second, the posterior is intractable.  In this section, we describe
how we circumvent these difficulties using a truncated variational Bayes
approximation (CITE).

In practice, forming a posterior based on \eqref{bnp_model} with $\kmax =
\infty$ can be challenging.  In the present paper, we will follow CITE BLEI and
use a ``truncated model'' where $\kmax$ is large but finite. We ensure that a
large proportion of the clusters are unoccupied with high posterior probability,
in which case the truncation approxes the fully nonparametric case with $\kmax =
\infty$ (CITE HUGGINS).  Under this truncation, the final cluster (indexed by
$\kmax$) can be thought of as capturing the contribution from the tail of
clusters that are not explicitly represented in the truncated model.

Under the truncation, our model differs formally from standard finite mixture
models principally in our usage of the stick breaking prior rather than, say,
the Dirichlet prior.  Using the stick breaking prior is appealing due to its
connection to the fully nonparametric model.  Additionally, the stick breaking
prior deals more gracefully than the Dirichlet prior with a large $\kmax$.  For
example, unless the Dirichlet parameter scales as $1 / \kmax$, then Dirichlet
priors strongly favor a large number of  distinct clusters as $\kmax$ grows
larger \citep[Problem 3]{stanford:2014:bnphw}.

Second, even with finite $\kmax$, the posterior for \eqref{bnp_model} is
intractable, so we again follow CITE BLEI and emply a mean field variational
approximation.  Let $\zeta := (\beta, \z, \nu)$ denote the full vector of
posterior parameters.  We form our variational approximation by specifying a
family of approximating distributions of the form $\q(\zeta \vert \eta)$,
parameterized by a finite-dimensional $\eta \in \etadom \subseteq
\mathbb{R}^{\etadim}$, such that $\q(\zeta \vert \eta)$ is absolutely continuous
with respect to the prior $\p(\zeta)$ for all $\eta \in \etadom$.  As we discuss
below, we will choose $\q(\zeta \vert \eta)$ so that we can easily compute or
approximation expectations with respect to $\q(\zeta \vert \eta)$, and so that
$\q(\zeta \vert \eta)$ has tractable entropy as a function of $\eta$.

Given our family of variational approximations, we wish to find the member of
the family that is closest to the posterior $\p(\zeta \vert \x)$ in
Kullback-Leibler (KL) divergence:
%
\begin{align}\eqlabel{vb_optimization}
%
\etaopt :={}&
    \argmin_{\eta \in \etadom}
        \KL{\q(\zeta \vert \eta) || \p(\zeta \vert \x)} \mathwhere \\
\KL{\q(\zeta \vert \eta) || \p(\zeta \vert \x)}
={}&    \expect{\q(\zeta \vert \eta)}{
        \log \q(\zeta \vert \eta) - \logp(\x \vert \zeta) -
        \logp(\zeta)} + \logp(\x). \nonumber
%
\end{align}
%
Due to properties of $\q(\zeta \vert \eta)$ or as given in \eqref{bnp_model},
all the terms in $\KL{\q(\zeta \vert \eta) || \p(\zeta \vert \x)}$ are tractable
except for $\logp(\x)$.  However, $\logp(\x)$ does not depend on $\eta$, and
so can be negelcted in the optimziation.

We will use mean-field variational approximating families of the following form:
%
\begin{align}\eqlabel{vb_mf}
%
\q(\zeta \vert \eta) =
    \left( \prod_{\k=1}^{\kmax - 1} \q(\nuk \vert \eta) \right)
    \left( \prod_{\k=1}^{\kmax} \q(\beta_\k \vert \eta) \right)
    \left( \prod_{\n=1}^{\N} \q(\z_{\n} \vert \eta) \right).
%
\end{align}
%
Under this parameterization, the vector $\eta$ will partition into parameters
governing $\nu$, $\beta$, and $\z$.  Let the VB parameters governing a
particular parameter vector be denoted with a subscript: for example, $\q(\beta
\vert \eta) = \q(\beta \vert \etatheta)$, $\q(\z_\n \vert \eta) = \q(\z \vert
\eta_{\z_{\n}})$, and so on.

For $\z$ and $\beta$, in the present work, we will be always able to take
advantage of conditional conjugacy.  Specifically, we will take $\q(\z_{\n}
\vert \eta)$ to be multinomial with a single observation, matching $\p(\z_{\n}
\vert \x, \beta, \nu)$, and we will take $\q(\beta_\k \vert \eta)$, matching
the distribution of $\p(\beta_{\k} \vert \x, \z, \nu)$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{ex}[VB approximation for $\beta_\k$]
%
Recall for the iris dataset we used $\p(\x_\n \vert \beta_\k) = \normdist{\x_n \vert
\mu_\k, \Sigma_\k}$, with $\beta_\k = (\mu_\k, \Sigma_\k)$.  So,
up to a constant not depending on $\eta$,
%
\begin{align*}
%
\MoveEqLeft
\expect{\q(\beta_\k \vert \eta)}{\logp(\x_\n \vert \beta_\k)} =\\
&
\expect{\q(\beta_\k \vert \eta)}{
-\frac{1}{2}(\x_n - \mu_k)^T \Sigma_\k^{-1} (\x_n - \mu_k)}
+\frac{1}{2} \expect{\q(\beta_\k \vert \eta)}{\log |\Sigma_\k^{-1}|}.
%
\end{align*}
%
By taking $\q(\beta_\k \vert \eta) = \wishart{\Sigma_\k^{-1} \vert \eta}
\normdist{\mu_\k \vert \eta}$, the expectations in the preceding display have closed
form expressions as functions of $\eta$, as does the entropy
$\expect{\q(\beta_\k \vert \eta)}{\log \q(\beta_\k \vert \eta)}$.
%
\end{ex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{ex}[VB approximation for $\z_\n$]\exlabel{qz_form}
%
From \eqref{bnp_model}, we have in general that
%
\begin{align*}
%
\logp(\z_n \vert \x, \beta, \nu) ={}&
\sum_{k=1}^{\kmax}
    \z_{\n\k} \left(
        \logp(\x_n \vert \beta_\k) + \log \pi_\k
    \right) + \const & \constdesc{\z_\n}.
%
\end{align*}
%
So, from the mean field assumption of \eqref{vb_mf},
%
\begin{align*}
%
\expect{\q(\zeta \vert \eta)}{\logp(\z_n \vert \x, \beta, \nu)} ={}&
\sum_{k=1}^{\kmax}
    \expect{\q(\z_\n \vert \eta)}{\z_{\n\k}}
    \expect{\q(\beta, \nu \vert \eta)}
           {\logp(\x_n \vert \beta_\k) + \log \pi_\k}.
%
\end{align*}
%
When $\q(\z_\n \vert \eta)$ is multinomial, the needed expectation
$\expect{\q(\z_\n \vert \eta)}{\z_{\n\k}}$ has a closed form, as does the
entropy,
%
\begin{align*}
%
\expect{\q(\z_\n \vert \eta)}{\log \q(\z_\n \vert \eta)} ={}&
    - \sum_{\k=1}^{\kmax}
        \expect{\q(\z_\n \vert \eta)}{\z_{\n\k}}
        \log \left( \expect{\q(\z_\n \vert \eta)}{\z_{\n\k}} \right).
%
\end{align*}
%
Additionally, given $\etatheta$ and $\etanu$, the optimal
variational distribution $\q(\z_\n \vert \etaoptz)$ has a closed form, with
%
\begin{align*}
%
\expect{\q(\z_\n \vert \etaopt)}{\z_{\n\k}} ={}&
\frac{
    \expect{\q(\beta, \nu \vert \eta)}
           {\logp(\x_n \vert \beta_\k) + \log \pi_\k}
}{
    \sum_{\k'=1}^{\kmax}
    \expect{\q(\beta, \nu \vert \eta)}
           {\logp(\x_n \vert \beta_{\k'}) + \log \pi_{\k'}}
}.
%
\end{align*}
%
This fact will be helpful later in \secref{local_sensitivity}.
%
\end{ex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

For our sensitivity analysis in \secref{local_sensitivity}, we will require
$\etaopt$ to be interior to $\etadom$.  Consequently, we will choose
unconstrained representations of the needed distributions or parameters.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%[Unconstrained representation for $\etaz$]
\begin{ex}\exlabel{qz_unconstrained}
%
The multinomial approximating distribution $\q(\z_\n \vert \etaz)$ as given in
\exref{qz_form} is fully specified by the expectations $\expect{\q(\z_\n \vert
\etaopt)}{\z_{\n\k}} \in (0, 1)$.  But these expectations have only $\kmax -1$
degrees of freedom since, for any valid $\q(\z_\n \vert \etaz)$,
$\sum_{\k=1}^\kmax \expect{\q(\z_\n \vert \etaopt)}{\z_{\n\k}} = 1$, and so the
optimal values for $\expect{\q(\z_\n \vert \etaopt)}{\z_{\n\k}}$ cannot be
interior to $(0,1)^\kmax$.  Consequently we parameterize
$\q(\z_\n \vert \etaz)$ using the unconstrained parameters $\rho_{\n\k}$,
for $\k=1,\ldots,\kmax - 1$, where
%
\begin{align*}
%
\expect{\q(\z_\n \vert \etaz)}{\z_{\n\k}} =
\begin{cases}
    \frac{\exp(\rho_{\n\k})}{1 + \sum_{\k'=1}^{\kmax - 1}\exp(\rho_{\n\k})}
    & \mathrm{ when }\quad\k < \kmax \\
    \frac{1}{1 + \sum_{\k'=1}^{\kmax - 1}\exp(\rho_{\n\k})}
    & \mathrm{ when }\quad\k = \kmax.
\end{cases}
%
\end{align*}
%
We thus take $\etaz = (\rho_{11}, \ldots \rho_{1(\kmax - 1)}, \ldots,
\rho_{\n(\kmax - 1)})$ to be the stacked vector of $\rho_{\n\k}$.
%
\end{ex}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



For the stick-breaking distributions $\q(\nuk \vert \eta)$ we will need to do
something more complicated, since we wish to accomodate generic stick breaking
distributions.  From \eqref{bnp_model} we see that, up to a constant not
depending on $\nuk$,
%
\begin{align}\eqlabel{stick_log_post}
%
\log \pi_\k ={}&
    \log \nuk + \sum_{\k' < \k} \log (1 - \nuk) \nonumber \\
\logp(\nu_{\k} \vert \x, \beta, \z) ={}&
    \left(\sum_{\n=1}^\N \z_{\n\k'}\right) \log \nuk +
    \left( \sum_{\k' > \k} \sum_{\n=1}^\N \z_{\n\k'} \right) \log (1 - \nuk) +
    \log \pstick(\nuk).
%
\end{align}
%
When $\pstick(\cdot) = \mathrm{Beta}(\cdot | 1, \alpha)$, then, up to a constant
not depending on $\nuk$, $\log \pstick(\nuk) = (\alpha - 1) \log (1 -
\nuk)$, so $\logp(\nu_{\k} \vert \x, \beta, \z)$ is proportional to the
sufficient statistics $\log \nuk$ and $\log(1 - \nuk)$ and so in the
Beta family.  However, for a generic $\pstick(\cdot)$, the posterior
$\p(\nu_{\k} \vert \x, \beta, \z)$ does not have a standard form.

In order to optimize the variational objective \eqref{vb_optimization} we see
from \eqref{stick_log_post} that we need to evaluate or approximate expectations
of the form
%
\begin{align*}
%
\expect{\q(\nuk \vert \eta)}{\log \nuk}
\textrm{,}\quad
\expect{\q(\nuk \vert \eta)}{\log (1 - \nuk)}
\textrm{,}\quad\textrm{and}\quad
\expect{\q(\nuk \vert \eta)}{\log \pstick(\nuk)}.
%
\end{align*}

Each of the expecations are univariate integrals, and so can be efficiently
approximated numerically.  A particularly easy way to do so is with
Gauss-Hermite (GH) quadrature, as we now describe.

First, define a version of $\nuk$ that is not constrained to $(0,1)$:
%
\begin{align*}
%
\lnu_\k :={} \log \left( \frac{\nuk}{1 - \nuk} \right)
\quad\Leftrightarrow\quad
\nuk :={} \frac{\exp(\lnu_\k)}{1 + \exp(\lnu_\k)}.
%\fracat{d \lnu_\k}{ d\nuk}{\nuk} ={}&
%     \frac{1-\nuk}{\nuk}
%     \left(\frac{1}{1 - \nuk} + \frac{\nuk}{(1 - \nuk)^2} \right)
% \\={}& \frac{1}{\nuk} + \frac{1}{1 - \nuk}
% \\={}&
%\frac{1}{\nuk (1 - \nuk)}.
%
\end{align*}
%
We wish to let $\lnu_\k$ be distributed normally under the variational
distribution.  Let $\lnumean_\k$ and $\lnusd_\k$ be entries of the parameter
vector $\eta$, and write
%
\begin{align*}
%
\q(\lnu_\k \vert \eta) ={}& \normdist{\lnu_\k \vert \lnumean_\k, \lnusd_\k}
\Rightarrow \\
\q(\nuk \vert \eta) ={}&
    \normdist{\log \left( \frac{\nuk}{1 - \nuk} \right)
        \vert \lnumean_\k, \lnusd_\k}
    \left|\fracat{d \lnu_\k}{ d\nuk}{\nuk}\right|
\\={}&
\normdist{\log \left( \frac{\nuk}{1 - \nuk} \right)
        \vert \lnumean_\k, \lnusd_\k}
    \left|\frac{1}{\nuk (1 - \nuk)}\right|.
%
\end{align*}
%
Given this, we can approximate expectations of smooth functions
$f(\nuk)$ using GH quadrature with $\ngh$ knots,
located at $\xi_g$, weighted by $\omega_g$:
%
\begin{align}\eqlabel{gh_integral}
%
\expect{\q(\nuk \vert \eta)}{f(\nuk)} ={}&
\expect{\q(\lnu_\k \vert \eta)}
       {f\left(\frac{\exp(\lnu_\k)}{1 + \exp(\lnu_\k)}\right)}
\nonumber\\\approx{}&
    \sum_{g=1}^{\ngh} \omega_g f\left(\lnusd_\k \xi_{g} + \lnumean_\k\right)
 \nonumber\\=:{}&
\expecthat{\q(\nuk \vert \eta)}{f(\nuk)}.
%
\end{align}
%
Conveniently, $\expecthat{\q(\nuk \vert \eta)}{f(\nuk)}$ is a differentiable
function of $\lnumean_\k$ and $\lnusd_\k$, and so also of $\eta$.  (This
technique is similar to the ``reparameterization trick,'' only using
GH points rather than standard normal draws.)
